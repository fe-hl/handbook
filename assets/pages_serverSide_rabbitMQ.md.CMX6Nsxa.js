import{_ as i,c as a,o as n,ao as t}from"./chunks/framework.DOhyS95j.js";const l="/handbook/assets/image-20240806135209860.Y9X2WdGN.png",h="/handbook/assets/image-20240805155818298.CZQkQjob.png",p="/handbook/assets/image-20240805160108001.B-CujK1F.png",e="/handbook/assets/wps1.BbaLGvNw.jpg",k="/handbook/assets/wps2.C2aF88vE.jpg",r="/handbook/assets/wps3.CP3aQMYw.jpg",E="/handbook/assets/wps4.CITyqcnV.jpg",d="/handbook/assets/wps5.B9rcZU2h.jpg",g="/handbook/assets/image-20240805160953981.DLdBBuAG.png",o="/handbook/assets/image-20240806084552095.C8XFqzq5.png",c="/handbook/assets/image-20240806084732986.ZlBc2U2f.png",y="/handbook/assets/image-20240806102134889.DXvmLiPt.png",F="/handbook/assets/image-20231102194452610.DZMGbsqA.png",u="/handbook/assets/image-20231102194633997.BwBrWV5I.png",b="/handbook/assets/image-20231102194746743.BagPXfuA.png",A="/handbook/assets/image-20231105151245299.B-ZoAMu-.png",m="/handbook/assets/image-20240321113218105.DIOltDjC.png",C="/handbook/assets/image-20240724113003339.BHOhSgnt.png",D="/handbook/assets/image-20240806084908636.CnFRCTqt.png",q="/handbook/assets/image-20240725175936170.BpXrpWZs.png",B="/handbook/assets/image-20240725180208216.QGALRNdx.png",v="/handbook/assets/img75.Cy1FdgEZ.png",f="/handbook/assets/image-20240725193430307.kDemH1Ph.png",_="/handbook/assets/img76.BPcccTiM.png",x="/handbook/assets/image-20240725194639024.DYBTwJkv.png",P="/handbook/assets/image-20240806102313708.By-UavOC.png",M="/handbook/assets/image-20240806084946234.B5EM4p8N.png",R="/handbook/assets/image-20240725203346015.D8i5AlEq.png",T="/handbook/assets/image-20240725203322613.2HucSEVy.png",w="/handbook/assets/image-20240806085107277.B3S7AlbV.png",Q="/handbook/assets/image-20240806085123819.C3UV7lC6.png",S="/handbook/assets/image-20240725210428356.BbgzLK6r.png",I="/handbook/assets/image-20240725210526288.DZCNdpL2.png",j="/handbook/assets/image-20240725210906899.DxQALeEH.png",N="/handbook/assets/image-20240725211118200.BN0xbPen.png",U="/handbook/assets/image-20240725211206904.DjZudznN.png",O="/handbook/assets/image-20240725212632041.B7v110GN.png",K="/handbook/assets/image-20240806085148987.CUAcSdsZ.png",G="/handbook/assets/image-20240725214547261.C-YAbeON.png",L="/handbook/assets/image-20240725214608820.FhuAEnBA.png",Y="/handbook/assets/image-20240725215245500.BamMntx1.png",H="/handbook/assets/image-20240806085214905.JH5BRyEY.png",X="/handbook/assets/wps14.BzGeWUhQ.jpg",z="/handbook/assets/image-20240725220957833.kWBnSNpl.png",W="/handbook/assets/image-20240725222339828.CK55fyTr.png",V="/handbook/assets/image-20240725222805072.CIAU4y_c.png",Z="/handbook/assets/image-20240725223737173.COTCc3jP.png",J="/handbook/assets/image-20240806085244893.CKFCXfM6.png",$="/handbook/assets/image-20240806085305207.DAjhtY3d.png",ss="/handbook/assets/image-20240806085325073.B7rIA67F.png",is="/handbook/assets/image-20240806085354471.C5Dzg8Ku.png",as="/handbook/assets/image-20240806085413115.B3CzVeu5.png",ns="/handbook/assets/image-20240806092424473.BC3AG3EQ.png",ts="/handbook/assets/image-20240806092503472.Cwcx1fTj.png",ls="/handbook/assets/image-20240806092558221.BJgwyEy2.png",hs="/handbook/assets/image-20240806092653865.DLksR-Yi.png",ps="/handbook/assets/img77.BtDDh7dt.png",es="/handbook/assets/image-20231106192621173.DAuhBwUS.png",ks="/handbook/assets/image-20231106192708597.DUx9ucGu.png",rs="/handbook/assets/image-20231106195216265.CYmCIPlV.png",Es="/handbook/assets/image-20231106195132627.CXYPhBoz.png",ds="/handbook/assets/image-20231106195748319.G5e9a-Yb.png",gs="/handbook/assets/image-20231106200245531.DuSZlxrZ.png",os="/handbook/assets/image-20231106200934265.B2OnDgU1.png",cs="/handbook/assets/image-20231106201123268.mKollZ0v.png",ys="/handbook/assets/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6.Coj22iI9.png",Fs="/handbook/assets/wps1-17229105587141.CsHFPB_U.jpg",us="/handbook/assets/wps2-17229106077093.B84Sm3zZ.jpg",bs="/handbook/assets/image-20240806094300945.FfDKEzif.png",As="data:image/png;base64,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",ms="data:image/png;base64,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",Cs="data:image/png;base64,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",Ds="data:image/png;base64,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",qs="data:image/png;base64,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",Bs="data:image/png;base64,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",vs="/handbook/assets/image-20240806094631068.Dg8AqcZF.png",fs="/handbook/assets/image-20231107162548129.Bn1hcLPs.png",_s="/handbook/assets/image-20231107162705883.DILu9QXT.png",xs="/handbook/assets/image-20231107163052001.CoybO7gc.png",Ps="/handbook/assets/image-20231107163534385.Da420eyi.png",Ms="/handbook/assets/image-20240806095014641.DiwxF2vi.png",Rs="/handbook/assets/image-20240318165821774.b7UlBnvj.png",Ts="/handbook/assets/image-20240318165927279.FcAuEuNG.png",ws="/handbook/assets/image-20231107170523503.FVfB0XHZ.png",Qs="/handbook/assets/image-20231107171231765.Ci49RZKy.png",Ss="/handbook/assets/img87.-_VBivYr.png",Is="/handbook/assets/image-20231107172002297.BQzENL52.png",js="/handbook/assets/image-20231107172234849.Bk-mTNMi.png",Ns="/handbook/assets/image-20231107172042460.DCErFOWs.png",Us="/handbook/assets/image-20240806095835083.DcLvOXMT.png",Os="/handbook/assets/image-20240806100015448.CPL-580e.png",Ks="/handbook/assets/image-20231107180045135.Cts8f_oO.png",Gs="/handbook/assets/image-20240321115348525.RKNNOnAL.png",Ls="/handbook/assets/image-20231107181914265.DB6s7rCj.png",Ys="/handbook/assets/image-20240319163915574.DcslAyVw.png",Hs="/handbook/assets/image-20240319171359652.C95xAviK.png",Xs="/handbook/assets/image-20240321115605608.B06eOLP5.png",zs="data:image/png;base64,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",ni=JSON.parse('{"title":"RabbitMQ","description":"","frontmatter":{},"headers":[],"relativePath":"pages/serverSide/rabbitMQ.md","filePath":"pages/serverSide/rabbitMQ.md","lastUpdated":1748585297000}'),Ws={name:"pages/serverSide/rabbitMQ.md"};function Vs(Zs,s,Js,$s,si,ii){return n(),a("div",null,s[0]||(s[0]=[t('<h1 id="rabbitmq" tabindex="-1">RabbitMQ <a class="header-anchor" href="#rabbitmq" aria-label="Permalink to &quot;RabbitMQ&quot;">​</a></h1><h2 id="_1-为什么学习消息队列" tabindex="-1">1 为什么学习消息队列 <a class="header-anchor" href="#_1-为什么学习消息队列" aria-label="Permalink to &quot;1 为什么学习消息队列&quot;">​</a></h2><p>在互联网应用中，经常需要对庞大的海量数据进行监控，随着网络技术和软件开发技术的不断提高，在实战开发中MQ的使用与日俱增，特别是RabbitMQ在分布式系统中存储转发消息，可以保证数据不丢失，也能保证高可用性，即集群部署的时候部分机器宕机可以继续运行。在大型电子商务类网站，如京东、淘宝、去哪儿等网站有着深入的应用 。</p><p>消息队列的主要作用是<strong>消除高并发访问高峰，加快网站的响应速度</strong>。</p><p>在不使用消息队列的情况下，用户的请求数据直接写入数据库，在高并发的情况下，会对数据库造成巨大的压力，同时也使得系统响应延迟加剧。</p><h2 id="_2-什么是消息中间件" tabindex="-1">2 什么是消息中间件 <a class="header-anchor" href="#_2-什么是消息中间件" aria-label="Permalink to &quot;2 什么是消息中间件&quot;">​</a></h2><p>MQ全称为<strong>Message Queue</strong>， 消息队列(MQ)是一种应用程序对应用程序的通信方法。</p><p>介绍：消息队列就是基础数据结构中的“先进先出”的一种数据机构。想一下，生活中买东西，需要排队，先排的人先买消费，就是典型的“先进先出”。</p><p><img src="'+l+'" alt="image-20240806135209860"></p><p>**消息传递：**指的是程序之间通过消息发送数据进行通信，而不是通过直接调用彼此来通信，直接调用通常是用于诸如远程过程调用的技术。</p><p>**排队：**指的是应用程序通过队列来通信。</p><p><strong>业务场景说明：</strong></p><p>消息队列在大型电子商务类网站，如京东、淘宝、去哪儿等网站有着深入的应用，为什么会产生消息队列？有几个原因：</p><p>不同进程（process）之间传递消息时，两个进程之间<strong>耦合</strong>程度过高，改动一个进程，引发必须修改另一个进程，为了<strong>隔离</strong>这两个进程，在两进程间抽离出一层（一个模块），所有两进程之间传递的消息，都必须通过消息队列来传递，单独修改某一个进程，不会影响另一个；</p><p>不同进程（process）之间传递消息时，为了实现标准化，将消息的格式规范化了，并且，某一个进程接受的<strong>消息太多</strong>，一下子无法处理完，并且也有先后顺序，必须对收到的消息<strong>进行排队</strong>，因此诞生了事实上的消息队列；</p><p>在项目中，可将一些无需即时返回且耗时的操作提取出来，进行<strong>异步处理</strong>，而这种异步处理的方式大大的节省了服务器的请求响应时间，从而<strong>提高</strong>了<strong>系统</strong>的<strong>吞吐量</strong>。</p><h2 id="_3-消息队列应用场景" tabindex="-1">3 消息队列应用场景 <a class="header-anchor" href="#_3-消息队列应用场景" aria-label="Permalink to &quot;3 消息队列应用场景&quot;">​</a></h2><p>首先我们先说一下消息中间件的主要的作用：</p><p><strong>[1]异步处理</strong></p><p><strong>[2]解耦服务</strong></p><p><strong>[3]流量削峰</strong></p><p>上面的三点是我们使用消息中间件最主要的目的.</p><h3 id="_3-1-应用解耦" tabindex="-1">3.1 应用解耦 <a class="header-anchor" href="#_3-1-应用解耦" aria-label="Permalink to &quot;3.1 应用解耦&quot;">​</a></h3><ul><li>以下单功能为例，如下图，存在功能耦合度高的问题。</li><li>用户下单，需要保存订单，更新购物车，更新库存，还要更新积分，如果在操作过程中，有任何一个环节失败了，最终会导致操作失败，返回错误信息</li></ul><p><img src="'+h+'" alt="image-20240805155818298"></p><ul><li>而采用消息队列方式，可以很好的解决耦合度过高问题</li></ul><p><img src="'+p+'" alt="image-20240805160108001"></p><h3 id="_3-2-异步处理" tabindex="-1">3.2 异步处理 <a class="header-anchor" href="#_3-2-异步处理" aria-label="Permalink to &quot;3.2 异步处理&quot;">​</a></h3><p>场景说明：用户注册后，需要发注册邮件和注册短信，传统的做法有两种</p><ul><li><p>串行的方式</p></li><li><p>并行的方式</p></li></ul><p><strong>(1)</strong> <strong>串行方式：</strong></p><p>将注册信息写入数据库后，发送注册邮件，再发送注册短信，以上三个任务全部完成后才返回给客户端。 这有一个问题是，邮件，短信并不是必须的，它只是一个通知，而这种做法让客户端等待没有必要等待的东西。</p><p><img src="'+e+'" alt="img"></p><p><strong>(2)</strong> <strong>并行方式：</strong></p><p>将注册信息写入数据库后，发送邮件的同时，发送短信，以上三个任务完成后，返回给客户端，并行的方式能提高处理的时间。</p><p><img src="'+k+'" alt="img"></p><p>假设三个业务节点分别使用50ms，串行方式使用时间150ms，并行使用时间100ms。虽然并行已经提高了处理时间，但是，前面说过，邮件和短信对我正常的使用网站没有任何影响，客户端没有必要等着其发送完成才显示注册成功，应该是写入数据库后就返回.</p><p><strong>(3)消息队列</strong> 引入消息队列后，把发送邮件，短信不是必须的业务逻辑异步处理</p><p><img src="'+r+'" alt="img"></p><p>由此可以看出，引入消息队列后，用户的响应时间就等于写入数据库的时间+写入消息队列的时间(可以忽略不计)，</p><p>引入消息队列后处理后，响应时间是串行的3分之1，是并行的2分之1。</p><p><strong>传统模式的缺点：</strong></p><p>· 一些非必要的业务逻辑以同步的方式运行，太耗费时间。</p><p><strong>中间件模式的的优点：</strong></p><p>· 将消息写入消息队列，非必要的业务逻辑以异步的方式运行，加快响应速度</p><h3 id="_3-3-流量削峰" tabindex="-1">3.3 流量削峰 <a class="header-anchor" href="#_3-3-流量削峰" aria-label="Permalink to &quot;3.3 流量削峰&quot;">​</a></h3><p>流量削峰一般在秒杀活动中应用广泛</p><p><strong>场景：</strong> 秒杀活动，一般会因为流量过大，导致应用挂掉，为了解决这个问题，一般在应用前端加入消息队列。</p><p><strong>传统模式</strong></p><p>如订单系统，在下单的时候就会往数据库写数据。但是数据库只能支撑每秒1000左右的并发写入，并发量再高就容易宕机。低峰期的时候并发也就100多个，但是在高峰期时候，并发量会突然激增到5000以上，这个时候数据库肯定卡死了。</p><p><img src="'+E+'" alt="img"></p><p><strong>传统模式的缺点：</strong></p><p>· 并发量大的时候，所有的请求直接怼到数据库，造成数据库连接异常</p><p><strong>中间件模式：</strong></p><p>消息被MQ保存起来了，然后系统就可以按照自己的消费能力来消费，比如每秒1000个数据，这样慢慢写入数据库，这样就不会卡死数据库了。</p><p><img src="'+d+'" alt="img"></p><p><strong>中间件模式的的优点：</strong></p><p>系统A慢慢按照数据库能处理的并发量，从消息队列中拉取消息。在生产中，这个短暂的高峰期积压是允许的。</p><p><strong>流量削峰也叫做削峰填谷</strong></p><p>使用了MQ之后，限制消费消息的速度为1000，但是这样一来，高峰期产生的数据势必会被积压在MQ中，高峰就被“削”掉了。但是因为消息积压，在高峰期过后的一段时间内，消费消息的速度还是会维持在 3消费完积压的消息，这就叫做“填谷”</p><h2 id="_4-amqp-和-jms" tabindex="-1"><strong>4 AMQP 和 JMS</strong> <a class="header-anchor" href="#_4-amqp-和-jms" aria-label="Permalink to &quot;**4 AMQP 和 JMS**&quot;">​</a></h2><p>MQ是消息通信的模型；实现MQ的大致有两种主流方式：AMQP、JMS。</p><h3 id="_4-1-amqp" tabindex="-1"><strong>4.1. AMQP</strong> <a class="header-anchor" href="#_4-1-amqp" aria-label="Permalink to &quot;**4.1. AMQP**&quot;">​</a></h3><p>AMQP是一种**高级消息队列协议（Advanced Message Queuing Protocol），更准确的说是一种binary wire-level protocol（**链接协议）。这是其和JMS的本质差别，AMQP不从API层进行限定，而是直接定义网络交换的数据格式。</p><h3 id="_4-2-jms" tabindex="-1"><strong>4.2. JMS</strong> <a class="header-anchor" href="#_4-2-jms" aria-label="Permalink to &quot;**4.2. JMS**&quot;">​</a></h3><p>JMS即**Java消息服务（JavaMessage Service）**应用程序接口，是一个Java平台中关于面向消息中间件（MOM）的API，用于在两个应用程序之间，或分布式系统中发送消息，进行异步通信。</p><h3 id="_4-3-amqp-与-jms-区别" tabindex="-1"><strong>4.3. AMQP 与 JMS 区别</strong> <a class="header-anchor" href="#_4-3-amqp-与-jms-区别" aria-label="Permalink to &quot;**4.3. AMQP 与 JMS 区别**&quot;">​</a></h3><p>· JMS是定义了统一的接口，来对消息操作进行统一；AMQP是通过规定协议来统一数据交互的格式</p><p>· JMS限定了必须使用Java语言；AMQP只是协议，不规定实现方式，因此是跨语言的。</p><p>· JMS规定了两种消息模式；而AMQP的消息模式更加丰富</p><h2 id="_5-消息队列产品" tabindex="-1"><strong>5 消息队列产品</strong> <a class="header-anchor" href="#_5-消息队列产品" aria-label="Permalink to &quot;**5 消息队列产品**&quot;">​</a></h2><p>市场上常见的消息队列有如下：</p><p>· ActiveMQ：基于JMS</p><p>· ZeroMQ：基于C语言开发</p><p>· Rabbitmq:基于AMQP协议，erlang语言开发，稳定性好</p><p>· RocketMQ：基于JMS，阿里巴巴产品</p><p>· Kafka：类似MQ的产品；分布式消息系统，高吞吐量</p><p><img src="'+g+'" alt="image-20240805160953981"></p><h2 id="_6-rabbitmq介绍" tabindex="-1">6 RabbitMQ介绍 <a class="header-anchor" href="#_6-rabbitmq介绍" aria-label="Permalink to &quot;6 RabbitMQ介绍&quot;">​</a></h2><h3 id="_6-1-简介" tabindex="-1">6.1 简介 <a class="header-anchor" href="#_6-1-简介" aria-label="Permalink to &quot;6.1 简介&quot;">​</a></h3><p>RabbitMQ是由erlang语言开发，基于AMQP（Advanced Message Queue 高级消息队列协议）协议实现的消息队列，它是一种应用程序之间的通信方法，消息队列在分布式系统开发中应用非常广泛。</p><p>AMQP，即 Advanced Message Queuing Protocol（高级消息队列协议），是一个网络协议，是应用层协议的一个开放标准，为面向消息的中间件设计。基于此协议的客户端与消息中间件可传递消息，并不受客户端/中间件不同产品，不同的开发语言等条件的限制。2006年，AMQP 规范发布。类比HTTP。</p><p>2007年，Rabbit 技术公司基于 AMQP 标准开发的 RabbitMQ 1.0 发布。RabbitMQ 采用 Erlang 语言开发。Erlang 语言由 Ericson 设计，专门为开发高并发和分布式系统的一种语言，在电信领域使用广泛。</p><p>RabbitMQ官方地址：<a href="http://www.rabbitmq.com/" target="_blank" rel="noreferrer">http://www.rabbitmq.com/</a></p><p>RabbitMQ提供了<strong>多种工作模式</strong>：简单模式，work模式 ，Publish/Subscribe发布与订阅模式，Routing路由模式，Topics主题模式等</p><p>官网对应模式介绍：<a href="https://www.rabbitmq.com/getstarted.html" target="_blank" rel="noreferrer">https://www.rabbitmq.com/getstarted.html</a></p><p><img src="'+o+'" alt="image-20240806084552095"></p><p><img src="'+c+'" alt="image-20240806084732986"></p><h3 id="_6-2-rabbitmq基础架构" tabindex="-1">6.2 RabbitMQ基础架构 <a class="header-anchor" href="#_6-2-rabbitmq基础架构" aria-label="Permalink to &quot;6.2 RabbitMQ基础架构&quot;">​</a></h3><ul><li><strong>基础架构图</strong></li></ul><p><img src="'+y+`" alt="image-20240806102134889"></p><ul><li><strong>RabbitMQ相关概念</strong></li></ul><p>**Broker：**接收和分发消息的应用，RabbitMQ Server就是 Message Broker</p><p>**Virtual host：**出于多租户和安全因素设计的，把 AMQP 的基本组件划分到一个虚拟的分组中，类似于网络中的 namespace 概念。当多个不同的用户使用同一个 RabbitMQ server 提供的服务时，可以划分出多个vhost，每个用户在自己的 vhost 创建 exchange／queue 等</p><p>**Connection：**publisher／consumer 和 broker 之间的 TCP 连接</p><p>**Channel：**如果每一次访问 RabbitMQ 都建立一个 Connection，在消息量大的时候建立 TCP Connection的开销将是巨大的，效率也较低。Channel 是在 connection 内部建立的逻辑连接，如果应用程序支持多线程，通常每个thread创建单独的 channel 进行通讯，AMQP method 包含了channel id 帮助客户端和message broker 识别 channel，所以 channel 之间是完全隔离的。Channel 作为轻量级的 Connection 极大减少了操作系统建立 TCP connection 的开销</p><p>**Exchange：**message 到达 broker 的第一站，根据分发规则，匹配查询表中的 routing key，分发消息到queue 中去。常用的类型有：<strong>direct (point-to-point)</strong>， <strong>topic (publish-subscribe)</strong> and <strong>fanout (multicast)</strong></p><p>**Queue：**存储消息的容器，消息最终被送到这里，等待 consumer 取走</p><p>**Binding：**exchange 和 queue 之间的虚拟连接，binding 中可以包含 routing key。Binding 信息被保存到 exchange 中的查询表中，用于 message 的分发依据</p><h1 id="二、rabbitmq安装" tabindex="-1">二、RabbitMQ安装 <a class="header-anchor" href="#二、rabbitmq安装" aria-label="Permalink to &quot;二、RabbitMQ安装&quot;">​</a></h1><h2 id="_1-安装" tabindex="-1">1 安装 <a class="header-anchor" href="#_1-安装" aria-label="Permalink to &quot;1 安装&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 拉取镜像</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pull</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rabbitmq:3.12-management</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># -d 参数：后台运行 Docker 容器</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># --name 参数：设置容器名称</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># -p 参数：映射端口号，格式是“宿主机端口号:容器内端口号”。5672供客户端程序访问，15672供后台管理界面访问</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># -v 参数：卷映射目录</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># -e 参数：设置容器内的环境变量，这里我们设置了登录RabbitMQ管理后台的默认用户和密码</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">--name </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">rabbitmq</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-p </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">5672:5672</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-p </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">15672:15672</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-v </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">rabbitmq-plugin:/plugins</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">RABBITMQ_DEFAULT_USER=guest</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">RABBITMQ_DEFAULT_PASS=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">123456</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">rabbitmq:3.12.0-management</span></span></code></pre></div><h2 id="_2-验证" tabindex="-1">2 验证 <a class="header-anchor" href="#_2-验证" aria-label="Permalink to &quot;2 验证&quot;">​</a></h2><p>访问后台管理界面：<code>http://192.168.200.100:15672</code></p><p><img src="`+F+'" alt="image-20231102194452610"></p><p>使用上面创建Docker容器时指定的默认用户名、密码登录：</p><p><img src="'+u+'" alt="image-20231102194633997"></p><p><img src="'+b+'" alt="image-20231102194746743"></p><h2 id="_3-可能的问题1-docker升级" tabindex="-1">3 可能的问题1：Docker升级 <a class="header-anchor" href="#_3-可能的问题1-docker升级" aria-label="Permalink to &quot;3 可能的问题1：Docker升级&quot;">​</a></h2><h3 id="_3-1-问题现象" tabindex="-1">3.1 问题现象 <a class="header-anchor" href="#_3-1-问题现象" aria-label="Permalink to &quot;3.1 问题现象&quot;">​</a></h3><p>在使用Docker拉取RabbitMQ镜像的时候，如果遇到提示：missing signature key，那就说明Docker版本太低了，需要升级</p><p>比如我目前的Docker版本如下图所示：</p><p><img src="'+A+`" alt="image-20231105151245299"></p><h3 id="_3-2-解决办法" tabindex="-1">3.2 解决办法 <a class="header-anchor" href="#_3-2-解决办法" aria-label="Permalink to &quot;3.2 解决办法&quot;">​</a></h3><blockquote><p>基于CentOS7</p></blockquote><h4 id="_1卸载当前docker" tabindex="-1">①卸载当前Docker <a class="header-anchor" href="#_1卸载当前docker" aria-label="Permalink to &quot;①卸载当前Docker&quot;">​</a></h4><p>更好的办法是安装Docker前曾经给服务器拍摄了快照，此时恢复快照；</p><p>如果不曾拍摄快照，那只能执行卸载操作了</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">yum</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> erase</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -y</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  docker-client</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  docker-client-latest</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  docker-common</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  docker-latest</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  docker-latest-logrotate</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  docker-logrotate</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  docker-selinux</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  docker-engine-selinux</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  docker-engine</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  docker-ce</span></span></code></pre></div><h4 id="_2升级yum库" tabindex="-1">②升级yum库 <a class="header-anchor" href="#_2升级yum库" aria-label="Permalink to &quot;②升级yum库&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">yum</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -y</span></span></code></pre></div><h4 id="_3安装docker最新版" tabindex="-1">③安装Docker最新版 <a class="header-anchor" href="#_3安装docker最新版" aria-label="Permalink to &quot;③安装Docker最新版&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">yum</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -y</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker-ce</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker-ce-cli</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containerd.io</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker-buildx-plugin</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker-compose-plugin</span></span></code></pre></div><p>如果这一步看到提示：没有可用软件包 docker-ce，那就添加Docker的yum源：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">yum</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -y</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> yum-utils</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">yum-config-manager</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --add-repo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://download.docker.com/linux/centos/docker-ce.repo</span></span></code></pre></div><h4 id="_4设置docker服务" tabindex="-1">④设置Docker服务 <a class="header-anchor" href="#_4设置docker服务" aria-label="Permalink to &quot;④设置Docker服务&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> start</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enable</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker</span></span></code></pre></div><h3 id="_3-3-验证" tabindex="-1">3.3 验证 <a class="header-anchor" href="#_3-3-验证" aria-label="Permalink to &quot;3.3 验证&quot;">​</a></h3><p>上述操作执行完成后，再次查看Docker版本：</p><p><img src="`+m+'" alt="image-20240321113218105"></p><h2 id="_4-可能的问题-拉取镜像失败" tabindex="-1">4 可能的问题：拉取镜像失败 <a class="header-anchor" href="#_4-可能的问题-拉取镜像失败" aria-label="Permalink to &quot;4 可能的问题：拉取镜像失败&quot;">​</a></h2><h3 id="_1、问题现象" tabindex="-1">1、问题现象 <a class="header-anchor" href="#_1、问题现象" aria-label="Permalink to &quot;1、问题现象&quot;">​</a></h3><p><img src="'+C+`" alt="image-20240724113003339"></p><h3 id="_2、解决办法" tabindex="-1">2、解决办法 <a class="header-anchor" href="#_2、解决办法" aria-label="Permalink to &quot;2、解决办法&quot;">​</a></h3><h4 id="_1daemon-json" tabindex="-1">①daemon.json <a class="header-anchor" href="#_1daemon-json" aria-label="Permalink to &quot;①daemon.json&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 新建或修改 docker 守护进程配置文件：daemon.json</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/docker/daemon.json</span></span></code></pre></div><h4 id="_2修改镜像源" tabindex="-1">②修改镜像源 <a class="header-anchor" href="#_2修改镜像源" aria-label="Permalink to &quot;②修改镜像源&quot;">​</a></h4><div class="language-properties vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">properties</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;registry-mirrors&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://registry.dockermirror.com&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h4 id="_3重启docker服务" tabindex="-1">③重启docker服务 <a class="header-anchor" href="#_3重启docker服务" aria-label="Permalink to &quot;③重启docker服务&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker</span></span></code></pre></div><h4 id="_4查看修改后的镜像源" tabindex="-1">④查看修改后的镜像源 <a class="header-anchor" href="#_4查看修改后的镜像源" aria-label="Permalink to &quot;④查看修改后的镜像源&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> info</span></span></code></pre></div><h1 id="rabbitmq入门案例" tabindex="-1">RabbitMQ入门案例 <a class="header-anchor" href="#rabbitmq入门案例" aria-label="Permalink to &quot;RabbitMQ入门案例&quot;">​</a></h1><h1 id="一、目标" tabindex="-1">一、目标 <a class="header-anchor" href="#一、目标" aria-label="Permalink to &quot;一、目标&quot;">​</a></h1><p>生产者发送消息，消费者接收消息，用最简单的方式实现</p><p><img src="`+D+'" alt="image-20240806084908636"></p><h1 id="二、创建队列" tabindex="-1">二、创建队列 <a class="header-anchor" href="#二、创建队列" aria-label="Permalink to &quot;二、创建队列&quot;">​</a></h1><p><img src="'+q+'" alt="image-20240725175936170"></p><p>队列名称：atguigu.queue.simple</p><p><img src="'+B+'" alt="image-20240725180208216"></p><h1 id="三、java-客户端-整合-springboot" tabindex="-1">三、Java 客户端：整合 SpringBoot <a class="header-anchor" href="#三、java-客户端-整合-springboot" aria-label="Permalink to &quot;三、Java 客户端：整合 SpringBoot&quot;">​</a></h1><h2 id="_1、生产者端工程" tabindex="-1">1、生产者端工程 <a class="header-anchor" href="#_1、生产者端工程" aria-label="Permalink to &quot;1、生产者端工程&quot;">​</a></h2><h3 id="_1创建module" tabindex="-1">①创建module <a class="header-anchor" href="#_1创建module" aria-label="Permalink to &quot;①创建module&quot;">​</a></h3><p><img src="'+v+`" alt="images"></p><h3 id="_2配置pom" tabindex="-1">②配置POM <a class="header-anchor" href="#_2配置pom" aria-label="Permalink to &quot;②配置POM&quot;">​</a></h3><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">parent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;org.springframework.boot&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;spring-boot-starter-parent&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;3.1.5&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">parent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependencies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;org.springframework.boot&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;spring-boot-starter-amqp&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;org.springframework.boot&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;spring-boot-starter-test&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependencies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre></div><h3 id="_3yaml" tabindex="-1">③YAML <a class="header-anchor" href="#_3yaml" aria-label="Permalink to &quot;③YAML&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  rabbitmq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    host</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168.47.100</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5672</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    username</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">guest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    password</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">123456</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    virtual-host</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span></span></code></pre></div><h3 id="_4主启动类" tabindex="-1">④主启动类 <a class="header-anchor" href="#_4主启动类" aria-label="Permalink to &quot;④主启动类&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.at.mq;  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.boot.SpringApplication;  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.boot.autoconfigure.SpringBootApplication;  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SpringBootApplication</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RabbitMQProducerMainType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        SpringApplication.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(RabbitMQProducerMainType.class, args);  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_5测试程序" tabindex="-1">⑤测试程序 <a class="header-anchor" href="#_5测试程序" aria-label="Permalink to &quot;⑤测试程序&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.at.mq.test;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.junit.jupiter.api.Test;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.rabbit.core.RabbitTemplate;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.beans.factory.annotation.Autowired;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.boot.test.context.SpringBootTest;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SpringBootTest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RabbitMQTest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 在简单模式下，没有用到交换机</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String EXCHANGE_DIRECT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 在简单模式下，消息直接发送到队列，此时生产者端需要把队列名称从路由键参数这里传入</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String ROUTING_KEY_SIMPLE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;at.queue.simple&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 注入 RabbitTemplate 执行</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RabbitTemplate rabbitTemplate;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> testSendMessageSimple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 发送消息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        rabbitTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">convertAndSend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                EXCHANGE_DIRECT,   	</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 指定交换机名称</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                ROUTING_KEY_SIMPLE, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 指定路由键名称</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                &quot;Hello at&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 消息内容，也就是消息数据本身</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_6测试效果" tabindex="-1">⑥测试效果 <a class="header-anchor" href="#_6测试效果" aria-label="Permalink to &quot;⑥测试效果&quot;">​</a></h3><p>消息发送到了队列中：</p><p><img src="`+f+'" alt="image-20240725193430307"></p><h2 id="_2、消费端工程" tabindex="-1">2、消费端工程 <a class="header-anchor" href="#_2、消费端工程" aria-label="Permalink to &quot;2、消费端工程&quot;">​</a></h2><h3 id="_1创建module-1" tabindex="-1">①创建module <a class="header-anchor" href="#_1创建module-1" aria-label="Permalink to &quot;①创建module&quot;">​</a></h3><p><img src="'+_+`" alt="images"></p><h3 id="_2配置pom-1" tabindex="-1">②配置POM <a class="header-anchor" href="#_2配置pom-1" aria-label="Permalink to &quot;②配置POM&quot;">​</a></h3><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">parent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;org.springframework.boot&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;spring-boot-starter-parent&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;3.1.5&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">parent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependencies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;org.springframework.boot&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;spring-boot-starter-amqp&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependencies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre></div><h3 id="_3yaml-1" tabindex="-1">③YAML <a class="header-anchor" href="#_3yaml-1" aria-label="Permalink to &quot;③YAML&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  rabbitmq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    host</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168.47.100</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5672</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    username</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">guest</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    password</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">123456</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    virtual-host</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span></span></code></pre></div><h3 id="_4主启动类-1" tabindex="-1">④主启动类 <a class="header-anchor" href="#_4主启动类-1" aria-label="Permalink to &quot;④主启动类&quot;">​</a></h3><p>仿照生产者工程的主启动类，改一下类名即可</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.at.mq;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.boot.SpringApplication;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.boot.autoconfigure.SpringBootApplication;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SpringBootApplication</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RabbitMQConsumerMainType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        SpringApplication.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(RabbitMQConsumerMainType.class, args);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_5监听器" tabindex="-1">⑤监听器 <a class="header-anchor" href="#_5监听器" aria-label="Permalink to &quot;⑤监听器&quot;">​</a></h3><ul><li>使用 @RabbitListener 注解设定要监听的队列名称</li><li>消息数据使用和发送端一样的数据类型接收</li></ul><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.at.mq.listener;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.rabbitmq.client.Channel;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.core.Message;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.rabbit.annotation.RabbitListener;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Component;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Component</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyMessageListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RabbitListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">queues</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;at.queue.simple&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">messageContent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Message </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Channel </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">channel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;messageContent = &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> messageContent);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_6执行测试" tabindex="-1">⑥执行测试 <a class="header-anchor" href="#_6执行测试" aria-label="Permalink to &quot;⑥执行测试&quot;">​</a></h3><p>监听方法不能直接运行，请大家通过主启动类运行微服务。消费端取走消息之后，队列中就没有消息了：</p><p><img src="`+x+'" alt="image-20240725194639024"></p><h1 id="rabbitmq工作模式" tabindex="-1">RabbitMQ工作模式 <a class="header-anchor" href="#rabbitmq工作模式" aria-label="Permalink to &quot;RabbitMQ工作模式&quot;">​</a></h1><ul><li>RabbitMQ提供了<strong>多种工作模式</strong>：简单模式，work模式 ，Publish/Subscribe发布与订阅模式，Routing路由模式，Topics主题模式等</li></ul><p><img src="'+P+'" alt="image-20240806102313708"></p><p>官网对应模式介绍：<a href="https://www.rabbitmq.com/getstarted.html" target="_blank" rel="noreferrer">https://www.rabbitmq.com/getstarted.html</a></p><h1 id="_1-work-queues工作队列模式" tabindex="-1"><strong>1 Work queues工作队列模式</strong> <a class="header-anchor" href="#_1-work-queues工作队列模式" aria-label="Permalink to &quot;**1 Work queues工作队列模式**&quot;">​</a></h1><h2 id="_1-1-模式说明" tabindex="-1"><strong>1.1 模式说明</strong> <a class="header-anchor" href="#_1-1-模式说明" aria-label="Permalink to &quot;**1.1 模式说明**&quot;">​</a></h2><p><img src="'+M+`" alt="image-20240806084946234"></p><p>Work Queues与入门程序的简单模式相比，多了一个或一些消费端，多个消费端共同消费同一个队列中的消息。</p><p><strong>应用场景</strong>：对于 任务过重或任务较多情况使用工作队列可以提高任务处理的速度</p><h2 id="_1-2-工作队列模式代码" tabindex="-1">1.2 工作队列模式代码 <a class="header-anchor" href="#_1-2-工作队列模式代码" aria-label="Permalink to &quot;1.2 工作队列模式代码&quot;">​</a></h2><h3 id="_1-2-1-生产者代码" tabindex="-1">1.2.1 生产者代码 <a class="header-anchor" href="#_1-2-1-生产者代码" aria-label="Permalink to &quot;1.2.1 生产者代码&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String EXCHANGE_DIRECT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String ROUTING_KEY_WORK </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;at.queue.work&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Test</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> testSendMessageWork</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        rabbitTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">convertAndSend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                EXCHANGE_DIRECT,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                ROUTING_KEY_WORK,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                &quot;Hello at &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li><strong>发送消息效果</strong></li></ul><p><img src="`+R+'" alt="image-20240725203346015"></p><p><img src="'+T+`" alt="image-20240725203322613"></p><h3 id="_1-2-2-消费者代码" tabindex="-1">1.2.2 消费者代码 <a class="header-anchor" href="#_1-2-2-消费者代码" aria-label="Permalink to &quot;1.2.2 消费者代码&quot;">​</a></h3><h4 id="_1创建模块-配置pom" tabindex="-1">①创建模块，配置POM <a class="header-anchor" href="#_1创建模块-配置pom" aria-label="Permalink to &quot;①创建模块，配置POM&quot;">​</a></h4><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">parent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;org.springframework.boot&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;spring-boot-starter-parent&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;3.1.5&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">parent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependencies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;org.springframework.boot&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;spring-boot-starter-amqp&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependencies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre></div><h4 id="_2yaml" tabindex="-1">②YAML <a class="header-anchor" href="#_2yaml" aria-label="Permalink to &quot;②YAML&quot;">​</a></h4><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  rabbitmq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    host</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168.47.100</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5672</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    username</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">guest</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    password</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">123456</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    virtual-host</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10000</span></span></code></pre></div><h4 id="_3主启动类" tabindex="-1">③主启动类 <a class="header-anchor" href="#_3主启动类" aria-label="Permalink to &quot;③主启动类&quot;">​</a></h4><p>仿照生产者工程的主启动类，改一下类名即可</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.at.mq;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.boot.SpringApplication;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.boot.autoconfigure.SpringBootApplication;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SpringBootApplication</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RabbitMQConsumerMainType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        SpringApplication.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(RabbitMQConsumerMainType.class, args);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h4 id="_4监听器" tabindex="-1">④监听器 <a class="header-anchor" href="#_4监听器" aria-label="Permalink to &quot;④监听器&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.at.mq.listener;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.rabbitmq.client.Channel;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.core.Message;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.rabbit.annotation.RabbitListener;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.beans.factory.annotation.Value;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Component;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Component</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyMessageListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;\${server.port}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String serverPort;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RabbitListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">queues</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;at.queue.work&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">messageContent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Message </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Channel </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">channel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Server Port:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> serverPort </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot; Message Content:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> messageContent);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_1-2-3-运行效果" tabindex="-1">1.2.3 运行效果 <a class="header-anchor" href="#_1-2-3-运行效果" aria-label="Permalink to &quot;1.2.3 运行效果&quot;">​</a></h3><h4 id="_1消费端a" tabindex="-1">①消费端A <a class="header-anchor" href="#_1消费端a" aria-label="Permalink to &quot;①消费端A&quot;">​</a></h4><blockquote><p>Server Port:10000 Message Content:Hello at 0 Server Port:10000 Message Content:Hello at 2 Server Port:10000 Message Content:Hello at 4 Server Port:10000 Message Content:Hello at 6 Server Port:10000 Message Content:Hello at 8</p></blockquote><h4 id="_2消费端b" tabindex="-1">②消费端B <a class="header-anchor" href="#_2消费端b" aria-label="Permalink to &quot;②消费端B&quot;">​</a></h4><blockquote><p>Server Port:20000 Message Content:Hello at 1 Server Port:20000 Message Content:Hello at 3 Server Port:20000 Message Content:Hello at 5 Server Port:20000 Message Content:Hello at 7 Server Port:20000 Message Content:Hello at 9</p></blockquote><h1 id="_2-订阅模式类型" tabindex="-1"><strong>2 订阅模式类型</strong> <a class="header-anchor" href="#_2-订阅模式类型" aria-label="Permalink to &quot;**2 订阅模式类型**&quot;">​</a></h1><p>订阅模式示例图：</p><p><img src="`+w+'" alt="image-20240806085107277"></p><p>前面2个案例中，只有3个角色：</p><p>· P：生产者，也就是要发送消息的程序</p><p>· C：消费者：消息的接受者，会一直等待消息到来。</p><p>· queue：消息队列，图中红色部分</p><p>而在订阅模型中，多了一个exchange角色，而且过程略有变化：</p><p>· P：生产者，也就是要发送消息的程序，但是不再发送到队列中，而是发给X（交换机）</p><p>· C：消费者，消息的接受者，会一直等待消息到来。</p><p>· Queue：消息队列，接收消息、缓存消息。</p><p>· Exchange：交换机，图中的X。一方面，接收生产者发送的消息。另一方面，知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于Exchange的类型。</p><p><strong>Exchange有常见以下3种类型</strong>：</p><p>o Fanout：广播，将消息交给所有绑定到交换机的队列</p><p>o Direct：定向，把消息交给符合指定routing key 的队列</p><p>o Topic：通配符，把消息交给符合routing pattern（路由模式） 的队列</p><p><strong>Exchange（交换机）只负责转发消息，不具备存储消息的能力</strong>，因此如果没有任何队列与Exchange绑定，或者没有符合路由规则的队列，那么消息会丢失！</p><h1 id="_3-publish-subscribe发布订阅模式" tabindex="-1">3 Publish/Subscribe发布订阅模式 <a class="header-anchor" href="#_3-publish-subscribe发布订阅模式" aria-label="Permalink to &quot;3 Publish/Subscribe发布订阅模式&quot;">​</a></h1><h2 id="_3-1-模式说明" tabindex="-1">3.1 模式说明 <a class="header-anchor" href="#_3-1-模式说明" aria-label="Permalink to &quot;3.1 模式说明&quot;">​</a></h2><p><img src="'+Q+'" alt="image-20240806085123819"></p><p>发布订阅模式： 1、每个消费者监听自己的队列。 2、生产者将消息发给broker，由交换机将消息转发到绑定此交换机的每个队列，每个绑定交换机的队列都将接收 到消息</p><h2 id="_3-2-代码实现" tabindex="-1">3.2 代码实现 <a class="header-anchor" href="#_3-2-代码实现" aria-label="Permalink to &quot;3.2 代码实现&quot;">​</a></h2><h3 id="_1-创建组件" tabindex="-1">1 创建组件 <a class="header-anchor" href="#_1-创建组件" aria-label="Permalink to &quot;1 创建组件&quot;">​</a></h3><ul><li>名称列表</li></ul><table tabindex="0"><thead><tr><th>组件</th><th>组件名称</th></tr></thead><tbody><tr><td>交换机</td><td>at.exchange.fanout</td></tr><tr><td>队列</td><td>at.queue.fanout01<br>at.queue.fanout02</td></tr></tbody></table><h3 id="_2-创建交换机" tabindex="-1">2 创建交换机 <a class="header-anchor" href="#_2-创建交换机" aria-label="Permalink to &quot;2 创建交换机&quot;">​</a></h3><p><span style="color:blue;"><strong>注意</strong></span>：发布订阅模式要求交换机是Fanout类型</p><p><img src="'+S+'" alt="image-20240725210428356"></p><p><img src="'+I+'" alt="image-20240725210526288"></p><h3 id="_3-创建队列并绑定交换机" tabindex="-1">3 创建队列并绑定交换机 <a class="header-anchor" href="#_3-创建队列并绑定交换机" aria-label="Permalink to &quot;3 创建队列并绑定交换机&quot;">​</a></h3><p><img src="'+j+'" alt="image-20240725210906899"></p><p><img src="'+N+'" alt="image-20240725211118200"></p><p>此时可以到交换机下查看绑定关系：</p><p><img src="'+U+`" alt="image-20240725211206904"></p><h3 id="_4-生产者代码" tabindex="-1">4 生产者代码 <a class="header-anchor" href="#_4-生产者代码" aria-label="Permalink to &quot;4 生产者代码&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String EXCHANGE_FANOUT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;at.exchange.fanout&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Test</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> testSendMessageFanout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    rabbitTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">convertAndSend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(EXCHANGE_FANOUT, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Hello fanout ~&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_5-消费者代码" tabindex="-1">5 消费者代码 <a class="header-anchor" href="#_5-消费者代码" aria-label="Permalink to &quot;5 消费者代码&quot;">​</a></h3><p>两个监听器可以写在同一个微服务中，分别监听两个不同队列：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.at.mq.listener;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.rabbitmq.client.Channel;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.core.Message;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.rabbit.annotation.RabbitListener;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Component;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Component</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyMessageListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RabbitListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">queues</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;at.queue.fanout01&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processMessage01</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">messageContent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Message </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Channel </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">channel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Consumer01 Message Content:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> messageContent);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RabbitListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">queues</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;at.queue.fanout02&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processMessage02</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">messageContent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Message </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Channel </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">channel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Consumer02 Message Content:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> messageContent);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_6-运行效果" tabindex="-1">6 运行效果 <a class="header-anchor" href="#_6-运行效果" aria-label="Permalink to &quot;6 运行效果&quot;">​</a></h3><p>先启动消费者，然后再运行生产者程序发送消息：</p><p><img src="`+O+'" alt="image-20240725212632041"></p><h2 id="_3-3-小结" tabindex="-1">3.3 小结 <a class="header-anchor" href="#_3-3-小结" aria-label="Permalink to &quot;3.3 小结&quot;">​</a></h2><p>交换机需要与队列进行绑定，绑定之后；一个消息可以被多个消费者都收到。</p><p><strong>发布订阅模式与工作队列模式的区别：</strong></p><ul><li>工作队列模式本质上是绑定默认交换机</li><li>发布订阅模式绑定指定交换机</li><li>监听同一个队列的消费端程序彼此之间是竞争关系</li><li>绑定同一个交换机的多个队列在发布订阅模式下，消息是广播的，每个队列都能接收到消息</li></ul><h1 id="_4-routing路由模式" tabindex="-1">4 Routing路由模式 <a class="header-anchor" href="#_4-routing路由模式" aria-label="Permalink to &quot;4 Routing路由模式&quot;">​</a></h1><h2 id="_4-1-模式说明" tabindex="-1">4.1 模式说明 <a class="header-anchor" href="#_4-1-模式说明" aria-label="Permalink to &quot;4.1 模式说明&quot;">​</a></h2><p>路由模式特点：</p><p>· 队列与交换机的绑定，不能是任意绑定了，而是要指定一个RoutingKey（路由key）</p><p>· 消息的发送方在 向 Exchange发送消息时，也必须指定消息的 RoutingKey。</p><p>· Exchange不再把消息交给每一个绑定的队列，而是根据消息的Routing Key进行判断，只有队列的Routingkey与消息的 Routing key完全一致，才会接收到消息</p><p><img src="'+K+'" alt="image-20240806085148987"></p><p>图解：</p><p>· P：生产者，向Exchange发送消息，发送消息时，会指定一个routing key。</p><p>· X：Exchange（交换机），接收生产者的消息，然后把消息递交给 与routing key完全匹配的队列</p><p>· C1：消费者，其所在队列指定了需要routing key 为 error 的消息</p><p>· C2：消费者，其所在队列指定了需要routing key 为 info、error、warning 的消息</p><h2 id="_4-2-代码实现" tabindex="-1">4.2 代码实现 <a class="header-anchor" href="#_4-2-代码实现" aria-label="Permalink to &quot;4.2 代码实现&quot;">​</a></h2><h3 id="_1-创建组件-1" tabindex="-1">1 创建组件 <a class="header-anchor" href="#_1-创建组件-1" aria-label="Permalink to &quot;1 创建组件&quot;">​</a></h3><ul><li>组件清单</li></ul><p>没有特殊设置，名称外的其它参数都使用默认值：</p><table tabindex="0"><thead><tr><th>组件</th><th>组件名称</th></tr></thead><tbody><tr><td>交换机</td><td>at.exchange.direct</td></tr><tr><td>路由键</td><td>at.routing.key.good</td></tr><tr><td>队列</td><td>at.queue.direct</td></tr></tbody></table><h3 id="_2-绑定" tabindex="-1">2 绑定 <a class="header-anchor" href="#_2-绑定" aria-label="Permalink to &quot;2 绑定&quot;">​</a></h3><p><img src="'+G+'" alt="image-20240725214547261"></p><p><img src="'+L+`" alt="image-20240725214608820"></p><h3 id="_3-生产者代码" tabindex="-1">3 生产者代码 <a class="header-anchor" href="#_3-生产者代码" aria-label="Permalink to &quot;3 生产者代码&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String EXCHANGE_DIRECT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;at.exchange.direct&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String ROUTING_KEY_GOOD </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;at.routing.key.good&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Test</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> testSendMessageRouting</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    rabbitTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">convertAndSend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(EXCHANGE_DIRECT, ROUTING_KEY_GOOD, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Hello routing ~&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_4-消费者代码" tabindex="-1">4 消费者代码 <a class="header-anchor" href="#_4-消费者代码" aria-label="Permalink to &quot;4 消费者代码&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RabbitListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">queues</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;at.queue.direct&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processMessageRouting</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String messageContent, Message message, Channel channel) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Message Content:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> messageContent);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_5-运行结果" tabindex="-1">5 运行结果 <a class="header-anchor" href="#_5-运行结果" aria-label="Permalink to &quot;5 运行结果&quot;">​</a></h3><p><img src="`+Y+'" alt="image-20240725215245500"></p><h1 id="_5-topics通配符模式" tabindex="-1">5 Topics通配符模式 <a class="header-anchor" href="#_5-topics通配符模式" aria-label="Permalink to &quot;5 Topics通配符模式&quot;">​</a></h1><h2 id="_5-1-模式说明" tabindex="-1"><strong>5.1. 模式说明</strong> <a class="header-anchor" href="#_5-1-模式说明" aria-label="Permalink to &quot;**5.1. 模式说明**&quot;">​</a></h2><p>Topic类型与Direct相比，都是可以根据RoutingKey把消息路由到不同的队列。只不过Topic类型Exchange可以让队列在绑定Routing key 的时候<strong>使用通配符</strong>！</p><p>Routingkey 一般都是有一个或多个单词组成，多个单词之间以”.”分割，例如： item.insert</p><p>通配符规则：</p><p>#：匹配零个或多个词</p><p>*：匹配不多不少恰好1个词</p><p>举例：</p><p>item.#：能够匹配item.insert.abc 或者 item.insert</p><p>item.*：只能匹配item.insert</p><p><img src="'+H+'" alt="image-20240806085214905"></p><p><img src="'+X+'" alt="img"></p><p>图解：</p><p>· 红色Queue：绑定的是usa.# ，因此凡是以 usa.开头的routing key 都会被匹配到</p><p>· 黄色Queue：绑定的是#.news ，因此凡是以 .news结尾的 routing key 都会被匹配</p><h2 id="_5-2-代码实现" tabindex="-1">5.2 代码实现 <a class="header-anchor" href="#_5-2-代码实现" aria-label="Permalink to &quot;5.2 代码实现&quot;">​</a></h2><h3 id="_1-创建组件-2" tabindex="-1">1 创建组件 <a class="header-anchor" href="#_1-创建组件-2" aria-label="Permalink to &quot;1 创建组件&quot;">​</a></h3><ul><li>组件清单</li></ul><table tabindex="0"><thead><tr><th>组件</th><th>组件名称</th></tr></thead><tbody><tr><td>交换机</td><td>at.exchange.topic</td></tr><tr><td>路由键</td><td>#.error<br>order.*<br>*.*</td></tr><tr><td>队列</td><td>at.queue.message<br>at.queue.order</td></tr></tbody></table><h3 id="_2-创建交换机-1" tabindex="-1">2 创建交换机 <a class="header-anchor" href="#_2-创建交换机-1" aria-label="Permalink to &quot;2 创建交换机&quot;">​</a></h3><p><img src="'+z+'" alt="image-20240725220957833"></p><h3 id="_3-绑定关系" tabindex="-1">3 绑定关系 <a class="header-anchor" href="#_3-绑定关系" aria-label="Permalink to &quot;3 绑定关系&quot;">​</a></h3><p><img src="'+W+'" alt="image-20240725222339828"></p><p><img src="'+V+`" alt="image-20240725222805072"></p><h3 id="_4-生产者代码-1" tabindex="-1">4 生产者代码 <a class="header-anchor" href="#_4-生产者代码-1" aria-label="Permalink to &quot;4 生产者代码&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String EXCHANGE_TOPIC </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;at.exchange.topic&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String ROUTING_KEY_ERROR </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;#.error&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String ROUTING_KEY_ORDER </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;order.*&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String ROUTING_KEY_ALL </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;*.*&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Test</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> testSendMessageTopic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    rabbitTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">convertAndSend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(EXCHANGE_TOPIC, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;order.info&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;message order info ...&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    rabbitTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">convertAndSend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(EXCHANGE_TOPIC, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;goods.info&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;message goods info ...&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    rabbitTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">convertAndSend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(EXCHANGE_TOPIC, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;goods.error&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;message goods error ...&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_5-消费者代码-1" tabindex="-1">5 消费者代码 <a class="header-anchor" href="#_5-消费者代码-1" aria-label="Permalink to &quot;5 消费者代码&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.at.mq.listener;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.rabbitmq.client.Channel;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.core.Message;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.rabbit.annotation.RabbitListener;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Component;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Component</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyMessageListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RabbitListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">queues</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;at.queue.message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processMessage01</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">messageContent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Message </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Channel </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">channel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Queue Message:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> messageContent);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RabbitListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">queues</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;at.queue.order&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processMessage02</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">messageContent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Message </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Channel </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">channel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Queue Order:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> messageContent);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_6-运行效果-1" tabindex="-1">6 运行效果 <a class="header-anchor" href="#_6-运行效果-1" aria-label="Permalink to &quot;6 运行效果&quot;">​</a></h3><p><img src="`+Z+'" alt="image-20240725223737173"></p><h1 id="_6-模式总结" tabindex="-1">6 模式总结 <a class="header-anchor" href="#_6-模式总结" aria-label="Permalink to &quot;6 模式总结&quot;">​</a></h1><h2 id="_1、简单模式-helloworld" tabindex="-1"><strong>1、简单模式 HelloWorld</strong> <a class="header-anchor" href="#_1、简单模式-helloworld" aria-label="Permalink to &quot;**1、简单模式 HelloWorld**&quot;">​</a></h2><p>一个生产者、一个消费者，不需要设置交换机（使用默认的交换机）</p><p><img src="'+J+'" alt="image-20240806085244893"></p><h2 id="_2、工作队列模式-work-queue" tabindex="-1"><strong>2、工作队列模式 Work Queue</strong> <a class="header-anchor" href="#_2、工作队列模式-work-queue" aria-label="Permalink to &quot;**2、工作队列模式 Work Queue**&quot;">​</a></h2><p>一个生产者、多个消费者（竞争关系），不需要设置交换机（使用默认的交换机）</p><p><img src="'+$+'" alt="image-20240806085305207"></p><h2 id="_3、发布订阅模式-publish-subscribe" tabindex="-1"><strong>3、发布订阅模式 Publish/subscribe</strong> <a class="header-anchor" href="#_3、发布订阅模式-publish-subscribe" aria-label="Permalink to &quot;**3、发布订阅模式 Publish/subscribe**&quot;">​</a></h2><p>需要设置类型为fanout的交换机，并且交换机和队列进行绑定，当发送消息到交换机后，交换机会将消息发送到绑定的队列</p><p><img src="'+ss+'" alt="image-20240806085325073"></p><h2 id="_4、路由模式-routing" tabindex="-1"><strong>4、路由模式 Routing</strong> <a class="header-anchor" href="#_4、路由模式-routing" aria-label="Permalink to &quot;**4、路由模式 Routing**&quot;">​</a></h2><p>需要设置类型为direct的交换机，交换机和队列进行绑定，并且指定routing key，当发送消息到交换机后，交换机会根据routing key将消息发送到对应的队列</p><p><img src="'+is+'" alt="image-20240806085354471"></p><h2 id="_5、通配符模式-topic" tabindex="-1"><strong>5、通配符模式 Topic</strong> <a class="header-anchor" href="#_5、通配符模式-topic" aria-label="Permalink to &quot;**5、通配符模式 Topic**&quot;">​</a></h2><p>需要设置类型为topic的交换机，交换机和队列进行绑定，并且指定通配符方式的routing key，当发送消息到交换机后，交换机会根据routing key将消息发送到对应的队列</p><p><img src="'+as+'" alt="image-20240806085413115"></p><h1 id="消息的可靠性投递" tabindex="-1">消息的可靠性投递 <a class="header-anchor" href="#消息的可靠性投递" aria-label="Permalink to &quot;消息的可靠性投递&quot;">​</a></h1><h1 id="_1-概述" tabindex="-1">1 概述 <a class="header-anchor" href="#_1-概述" aria-label="Permalink to &quot;1 概述&quot;">​</a></h1><h2 id="_1-1-问题引入" tabindex="-1">1.1 问题引入 <a class="header-anchor" href="#_1-1-问题引入" aria-label="Permalink to &quot;1.1 问题引入&quot;">​</a></h2><ul><li><strong>正常的下单流程</strong></li></ul><p><img src="'+ns+'" alt="image-20240806092424473"></p><ul><li><strong>故障情况1：</strong></li></ul><p><img src="'+ts+'" alt="image-20240806092503472"></p><p>消息没有发送到消息队列上，后果：消费者拿不到消息，业务功能缺失，数据错误</p><ul><li><strong>故障情况2：</strong></li></ul><p><img src="'+ls+'" alt="image-20240806092558221"></p><p>消息成功存入消息队列，但是消息队列服务器宕机了，原本保存在内存中的消息也丢失了，即使服务器重新启动，消息也找不回来了。后果：消费者拿不到消息，业务功能缺失，数据错误</p><ul><li><strong>故障情况3：</strong></li></ul><p><img src="'+hs+'" alt="image-20240806092653865"></p><p>消息成功存入消息队列，但是消费端出现问题，例如：宕机、抛异常等等。后果：业务功能缺失，数据错误</p><h2 id="_1-2-解决方案" tabindex="-1">1.2 解决方案 <a class="header-anchor" href="#_1-2-解决方案" aria-label="Permalink to &quot;1.2 解决方案&quot;">​</a></h2><ul><li><p>故障情况1：消息没有发送到消息队列在生产者端进行确认，具体操作中我们会分别针对交换机和队列来确认，如果没有成功发送到消息队列服务器上，那就可以尝试重新发送</p></li><li><p>故障情况2：消息队列服务器宕机导致内存中消息丢失解决思路：消息持久化到硬盘上，哪怕服务器重启也不会导致消息丢失</p></li><li><p>故障情况3：消费端宕机或抛异常导致消息没有成功被消费消费端消费消息成功，给服务器返回ACK信息，然后消息队列删除该消息消费端消费消息失败，给服务器端返回NACK信息，同时把消息恢复为待消费的状态，这样就可以再次取回消息，重试一次（当然，这就需要消费端接口支持幂等性）</p></li></ul><h1 id="_2-故障1解决-生产者端消息确认机制" tabindex="-1">2 故障1解决：生产者端消息确认机制 <a class="header-anchor" href="#_2-故障1解决-生产者端消息确认机制" aria-label="Permalink to &quot;2 故障1解决：生产者端消息确认机制&quot;">​</a></h1><h2 id="一、概述" tabindex="-1">一、概述 <a class="header-anchor" href="#一、概述" aria-label="Permalink to &quot;一、概述&quot;">​</a></h2><ul><li>在使用 RabbitMQ 的时候，作为消息发送方希望<strong>杜绝任何消息丢失</strong>或者<strong>投递失败</strong>场景。RabbitMQ 为我们提供了<strong>两种方式</strong>用来<strong>控制消息的投递可靠性模式</strong>。</li></ul><p><strong>·</strong> <strong>confirm 确认模式</strong></p><p><strong>·</strong> <strong>return 退回模式</strong></p><ul><li><strong>rabbitmq 整个消息投递的路径为：</strong></li></ul><p>producer—&gt;rabbitmq broker—&gt;exchange—&gt;queue—&gt;consumer</p><p><strong>·</strong> 消息从 producer 到 exchange 则会返回一个 confirmCallback 。</p><p><strong>·</strong> 消息从 exchange–&gt;queue 投递失败则会返回一个 returnCallback 。</p><p>我们将利用这两个 callback 控制消息的可靠性投递</p><h2 id="二、创建module" tabindex="-1">二、创建module <a class="header-anchor" href="#二、创建module" aria-label="Permalink to &quot;二、创建module&quot;">​</a></h2><p><img src="'+ps+`" alt="images"></p><h2 id="三、搭建环境" tabindex="-1">三、搭建环境 <a class="header-anchor" href="#三、搭建环境" aria-label="Permalink to &quot;三、搭建环境&quot;">​</a></h2><h3 id="_1、配置pom" tabindex="-1">1、配置POM <a class="header-anchor" href="#_1、配置pom" aria-label="Permalink to &quot;1、配置POM&quot;">​</a></h3><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">parent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;org.springframework.boot&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;spring-boot-starter-parent&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;3.1.5&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">parent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependencies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;org.springframework.boot&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;spring-boot-starter-amqp&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;org.springframework.boot&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;spring-boot-starter-test&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;org.projectlombok&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;lombok&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependencies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre></div><h3 id="_2、主启动类" tabindex="-1">2、主启动类 <a class="header-anchor" href="#_2、主启动类" aria-label="Permalink to &quot;2、主启动类&quot;">​</a></h3><p>没有特殊设定：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.at.mq;  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.boot.SpringApplication;  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.boot.autoconfigure.SpringBootApplication;  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SpringBootApplication</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RabbitMQProducerMainType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        SpringApplication.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(RabbitMQProducerMainType.class, args);  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_3、yaml" tabindex="-1">3、YAML <a class="header-anchor" href="#_3、yaml" aria-label="Permalink to &quot;3、YAML&quot;">​</a></h3><p><span style="color:blue;font-weight:bold;">注意</span>：publisher-confirm-type和publisher-returns是两个必须要增加的配置，如果没有则本节功能不生效</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  rabbitmq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    host</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168.200.100</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5672</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    username</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">guest</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    password</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">123456</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    virtual-host</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    publisher-confirm-type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CORRELATED</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 交换机的确认</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    publisher-returns</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 队列的确认</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">logging</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  level</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    com.at.mq.config.MQProducerAckConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">info</span></span></code></pre></div><h2 id="四、创建配置类" tabindex="-1">四、创建配置类 <a class="header-anchor" href="#四、创建配置类" aria-label="Permalink to &quot;四、创建配置类&quot;">​</a></h2><h3 id="_1、目标" tabindex="-1">1、目标 <a class="header-anchor" href="#_1、目标" aria-label="Permalink to &quot;1、目标&quot;">​</a></h3><p>在这里我们为什么要创建这个配置类呢？首先，我们需要声明回调函数来接收RabbitMQ服务器返回的确认信息：</p><table tabindex="0"><thead><tr><th>方法名</th><th>方法功能</th><th>所属接口</th><th>接口所属类</th></tr></thead><tbody><tr><td>confirm()</td><td>确认消息是否发送到交换机</td><td>ConfirmCallback</td><td>RabbitTemplate</td></tr><tr><td>returnedMessage()</td><td>确认消息是否发送到队列</td><td>ReturnsCallback</td><td>RabbitTemplate</td></tr></tbody></table><p>然后，就是对RabbitTemplate的功能进行增强，因为回调函数所在对象必须设置到RabbitTemplate对象中才能生效。</p><p>原本RabbitTemplate对象并没有生产者端消息确认的功能，要给它设置对应的组件才可以。</p><p>而设置对应的组件，需要调用RabbitTemplate对象下面两个方法：</p><table tabindex="0"><thead><tr><th>设置组件调用的方法</th><th>所需对象类型</th></tr></thead><tbody><tr><td>setConfirmCallback()</td><td>ConfirmCallback接口类型</td></tr><tr><td>setReturnCallback()</td><td>ReturnCallback接口类型</td></tr></tbody></table><h3 id="_2、api说明" tabindex="-1">2、API说明 <a class="header-anchor" href="#_2、api说明" aria-label="Permalink to &quot;2、API说明&quot;">​</a></h3><h4 id="_1confirmcallback接口" tabindex="-1">①ConfirmCallback接口 <a class="header-anchor" href="#_1confirmcallback接口" aria-label="Permalink to &quot;①ConfirmCallback接口&quot;">​</a></h4><p>这是RabbitTemplate内部的一个接口，源代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * A callback for publisher confirmations.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FunctionalInterface</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConfirmCallback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * Confirmation callback.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> correlationData</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> correlation data for the callback.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> ack</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> true for ack, false for nack</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> cause</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> An optional cause, for nack, when available, otherwise null.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> confirm</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Nullable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CorrelationData </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">correlationData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">boolean</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> ack</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Nullable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cause</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span></code></pre></div><p>生产者端发送消息之后，回调confirm()方法</p><ul><li>ack参数值为true：表示消息成功发送到了交换机</li><li>ack参数值为false：表示消息没有发送到交换机</li></ul><h4 id="_2returncallback接口" tabindex="-1">②ReturnCallback接口 <a class="header-anchor" href="#_2returncallback接口" aria-label="Permalink to &quot;②ReturnCallback接口&quot;">​</a></h4><p>同样也RabbitTemplate内部的一个接口，源代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * A callback for returned messages.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@since</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> 2.3</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FunctionalInterface</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ReturnsCallback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * Returned message callback.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> returned</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> the returned message and metadata.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> returnedMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ReturnedMessage </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">returned</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span></code></pre></div><p><span style="color:blue;font-weight:bold;">注意</span>：接口中的returnedMessage()方法<span style="color:blue;font-weight:bold;font-size:25px;">仅</span>在消息<span style="color:blue;font-weight:bold;font-size:25px;">没有</span>发送到队列时调用</p><p>ReturnedMessage类中主要属性含义如下：</p><table tabindex="0"><thead><tr><th>属性名</th><th>类型</th><th>含义</th></tr></thead><tbody><tr><td>message</td><td>org.springframework.amqp.core.Message</td><td>消息以及消息相关数据</td></tr><tr><td>replyCode</td><td>int</td><td>应答码，类似于HTTP响应状态码</td></tr><tr><td>replyText</td><td>String</td><td>应答码说明</td></tr><tr><td>exchange</td><td>String</td><td>交换机名称</td></tr><tr><td>routingKey</td><td>String</td><td>路由键名称</td></tr></tbody></table><h3 id="_3、配置类代码" tabindex="-1">3、配置类代码 <a class="header-anchor" href="#_3、配置类代码" aria-label="Permalink to &quot;3、配置类代码&quot;">​</a></h3><h4 id="_1要点1" tabindex="-1">①要点1 <a class="header-anchor" href="#_1要点1" aria-label="Permalink to &quot;①要点1&quot;">​</a></h4><p>加@Component注解，加入IOC容器</p><h4 id="_2要点2" tabindex="-1">②要点2 <a class="header-anchor" href="#_2要点2" aria-label="Permalink to &quot;②要点2&quot;">​</a></h4><p>配置类自身实现ConfirmCallback、ReturnCallback这两个接口，然后通过this指针把配置类的对象设置到RabbitTemplate对象中。</p><p>操作封装到了一个专门的void init()方法中。</p><p>为了保证这个void init()方法在应用启动时被调用，我们使用@PostConstruct注解来修饰这个方法。</p><p>关于@PostConstruct注解大家可以参照以下说明：</p><blockquote><p>@PostConstruct注解是<span style="color:blue;font-weight:bolder;">Java中的一个标准注解</span>，它用于指定在<span style="color:blue;font-weight:bolder;">对象创建之后立即执行</span>的方法。当使用依赖注入（如Spring框架）或者其他方式创建对象时，@PostConstruct注解可以确保在对象完全初始化之后，执行相应的方法。</p><p>使用@PostConstruct注解的方法必须满足以下条件：</p><ol><li><span style="color:blue;font-weight:bolder;">方法不能有任何参数</span>。</li><li><span style="color:blue;font-weight:bolder;">方法必须是非静态的</span>。</li><li><span style="color:blue;font-weight:bolder;">方法不能返回任何值</span>。</li></ol><p>当容器实例化一个带有@PostConstruct注解的Bean时，它会在<span style="color:blue;font-weight:bolder;">调用构造函数之后</span>，并在<span style="color:blue;font-weight:bolder;">依赖注入完成之前</span>调用被@PostConstruct注解标记的方法。这样，我们可以在该方法中进行一些初始化操作，比如读取配置文件、建立数据库连接等。</p></blockquote><h4 id="_3代码" tabindex="-1">③代码 <a class="header-anchor" href="#_3代码" aria-label="Permalink to &quot;③代码&quot;">​</a></h4><p>有了以上说明，下面我们就可以展示配置类的整体代码：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.at.mq.config;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jakarta.annotation.PostConstruct;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lombok.extern.slf4j.Slf4j;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.core.ReturnedMessage;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.rabbit.connection.CorrelationData;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.rabbit.core.RabbitTemplate;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.beans.factory.annotation.Autowired;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Component;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Component</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Slf4j</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MQProducerAckConfig</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RabbitTemplate.ConfirmCallback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">RabbitTemplate.ReturnsCallback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RabbitTemplate rabbitTemplate;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PostConstruct</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        rabbitTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setConfirmCallback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        rabbitTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setReturnsCallback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> confirm</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(CorrelationData </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">correlationData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">boolean</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> ack</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cause</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ack) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;消息发送到交换机成功！数据：&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> correlationData);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;消息发送到交换机失败！数据：&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> correlationData </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot; 原因：&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cause);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> returnedMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ReturnedMessage </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">returned</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;消息主体: &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(returned.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getBody</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;应答码: &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> returned.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getReplyCode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;描述：&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> returned.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getReplyText</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;消息使用的交换器 exchange : &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> returned.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getExchange</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;消息使用的路由键 routing : &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> returned.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getRoutingKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="五、发送消息" tabindex="-1">五、发送消息 <a class="header-anchor" href="#五、发送消息" aria-label="Permalink to &quot;五、发送消息&quot;">​</a></h2><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.at.mq.test;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.junit.jupiter.api.Test;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.rabbit.core.RabbitTemplate;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.beans.factory.annotation.Autowired;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.boot.test.context.SpringBootTest;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SpringBootTest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RabbitMQTest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String EXCHANGE_DIRECT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;exchange.direct.order&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String ROUTING_KEY </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;order&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RabbitTemplate rabbitTemplate;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> testSendMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        rabbitTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">convertAndSend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                EXCHANGE_DIRECT,   </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                ROUTING_KEY,   </span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                &quot;Hello at&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>通过调整代码，测试如下三种情况：</p><ul><li>交换机正确、路由键正确</li><li>交换机正确、路由键不正确，无法发送到队列</li><li>交换机不正确，无法发送到交换机</li></ul><h1 id="_3-故障2解决-交换机和队列持久化" tabindex="-1">3 故障2解决：交换机和队列持久化 <a class="header-anchor" href="#_3-故障2解决-交换机和队列持久化" aria-label="Permalink to &quot;3 故障2解决：交换机和队列持久化&quot;">​</a></h1><h2 id="一、测试非持久化交换机和队列" tabindex="-1">一、测试非持久化交换机和队列 <a class="header-anchor" href="#一、测试非持久化交换机和队列" aria-label="Permalink to &quot;一、测试非持久化交换机和队列&quot;">​</a></h2><h3 id="_1、创建非持久化交换机" tabindex="-1">1、创建非持久化交换机 <a class="header-anchor" href="#_1、创建非持久化交换机" aria-label="Permalink to &quot;1、创建非持久化交换机&quot;">​</a></h3><p><img src="`+es+'" alt="image-20231106192621173"></p><p>创建之后，可以在列表中看到：</p><p><img src="'+ks+'" alt="image-20231106192708597"></p><h3 id="_2、创建非持久化队列" tabindex="-1">2、创建非持久化队列 <a class="header-anchor" href="#_2、创建非持久化队列" aria-label="Permalink to &quot;2、创建非持久化队列&quot;">​</a></h3><p><img src="'+rs+'" alt="image-20231106195216265"></p><p>创建之后，可以在列表中看到：</p><p><img src="'+Es+'" alt="image-20231106195132627"></p><h3 id="_3、绑定" tabindex="-1">3、绑定 <a class="header-anchor" href="#_3、绑定" aria-label="Permalink to &quot;3、绑定&quot;">​</a></h3><p><img src="'+ds+`" alt="image-20231106195748319"></p><h3 id="_4、发送消息" tabindex="-1">4、发送消息 <a class="header-anchor" href="#_4、发送消息" aria-label="Permalink to &quot;4、发送消息&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String EXCHANGE_TRANSIENT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;exchange.transient.user&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String ROUTING_KEY_TRANSIENT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;user&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Test</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> testSendMessageTransient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        rabbitTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">convertAndSend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                EXCHANGE_TRANSIENT,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                ROUTING_KEY_TRANSIENT,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                &quot;Hello at user~~~&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span></code></pre></div><h3 id="_5、查看已发送消息" tabindex="-1">5、查看已发送消息 <a class="header-anchor" href="#_5、查看已发送消息" aria-label="Permalink to &quot;5、查看已发送消息&quot;">​</a></h3><p><img src="`+gs+'" alt="image-20231106200245531"></p><p>结论：临时性的交换机和队列也能够接收消息，但如果RabbitMQ服务器重启之后会怎么样呢？</p><h3 id="_6、重启rabbitmq服务器" tabindex="-1">6、重启RabbitMQ服务器 <a class="header-anchor" href="#_6、重启rabbitmq服务器" aria-label="Permalink to &quot;6、重启RabbitMQ服务器&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rabbitmq</span></span></code></pre></div><p>重启之后，刚才临时性的交换机和队列都没了。在交换机和队列这二者中，队列是消息存储的容器，队列没了，消息就也跟着没了。</p><h2 id="二、持久化的交换机和队列" tabindex="-1">二、持久化的交换机和队列 <a class="header-anchor" href="#二、持久化的交换机和队列" aria-label="Permalink to &quot;二、持久化的交换机和队列&quot;">​</a></h2><p>我们其实不必专门创建持久化的交换机和队列，因为它们默认就是持久化的。接下来我们只需要确认一下：存放到队列中，尚未被消费端取走的消息，是否会随着RabbitMQ服务器重启而丢失？</p><h3 id="_1、发送消息" tabindex="-1">1、发送消息 <a class="header-anchor" href="#_1、发送消息" aria-label="Permalink to &quot;1、发送消息&quot;">​</a></h3><p>运行以前的发送消息方法即可，不过要关掉消费端程序</p><h3 id="_2、在管理界面查看消息" tabindex="-1">2、在管理界面查看消息 <a class="header-anchor" href="#_2、在管理界面查看消息" aria-label="Permalink to &quot;2、在管理界面查看消息&quot;">​</a></h3><p><img src="'+os+'" alt="image-20231106200934265"></p><h3 id="_3、重启rabbitmq服务器" tabindex="-1">3、重启RabbitMQ服务器 <a class="header-anchor" href="#_3、重启rabbitmq服务器" aria-label="Permalink to &quot;3、重启RabbitMQ服务器&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rabbitmq</span></span></code></pre></div><h3 id="_4、再次查看消息" tabindex="-1">4、再次查看消息 <a class="header-anchor" href="#_4、再次查看消息" aria-label="Permalink to &quot;4、再次查看消息&quot;">​</a></h3><p>仍然还在：</p><p><img src="'+cs+`" alt="image-20231106201123268"></p><h2 id="三、结论" tabindex="-1">三、结论 <a class="header-anchor" href="#三、结论" aria-label="Permalink to &quot;三、结论&quot;">​</a></h2><p>在后台管理界面创建交换机和队列时，默认就是持久化的模式。</p><p>此时消息也是持久化的，不需要额外设置。</p><h1 id="_4-故障3解决-消费端消息确认" tabindex="-1">4 故障3解决：消费端消息确认 <a class="header-anchor" href="#_4-故障3解决-消费端消息确认" aria-label="Permalink to &quot;4 故障3解决：消费端消息确认&quot;">​</a></h1><h2 id="一、ack" tabindex="-1">一、ACK <a class="header-anchor" href="#一、ack" aria-label="Permalink to &quot;一、ACK&quot;">​</a></h2><p>ACK是acknowledge的缩写，表示已确认</p><h2 id="二、默认情况" tabindex="-1">二、默认情况 <a class="header-anchor" href="#二、默认情况" aria-label="Permalink to &quot;二、默认情况&quot;">​</a></h2><p>默认情况下，消费端取回消息后，默认会自动返回ACK确认消息，所以在前面的测试中消息被消费端消费之后，RabbitMQ得到ACK确认信息就会删除消息</p><p>但实际开发中，消费端根据消息队列投递的消息执行对应的业务，未必都能执行成功，如果希望能够多次重试，那么默认设定就不满足要求了</p><p>所以还是要修改成手动确认</p><h2 id="三、创建消费端module" tabindex="-1">三、创建消费端module <a class="header-anchor" href="#三、创建消费端module" aria-label="Permalink to &quot;三、创建消费端module&quot;">​</a></h2><h3 id="_1、配置pom-1" tabindex="-1">1、配置POM <a class="header-anchor" href="#_1、配置pom-1" aria-label="Permalink to &quot;1、配置POM&quot;">​</a></h3><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">parent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;org.springframework.boot&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;spring-boot-starter-parent&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;3.1.5&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">parent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependencies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;org.springframework.boot&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;spring-boot-starter-amqp&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;org.springframework.boot&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;spring-boot-starter-web&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;org.projectlombok&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;lombok&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependencies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre></div><h3 id="_2、yaml" tabindex="-1">2、YAML <a class="header-anchor" href="#_2、yaml" aria-label="Permalink to &quot;2、YAML&quot;">​</a></h3><p>增加针对监听器的设置：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  rabbitmq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    host</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168.200.100</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5672</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    username</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">guest</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    password</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">123456</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    virtual-host</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    listener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      simple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        acknowledge-mode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">manual</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 把消息确认模式改为手动确认</span></span></code></pre></div><h3 id="_3、主启动类" tabindex="-1">3、主启动类 <a class="header-anchor" href="#_3、主启动类" aria-label="Permalink to &quot;3、主启动类&quot;">​</a></h3><p>没有特殊设定：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.at.mq;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.boot.SpringApplication;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.boot.autoconfigure.SpringBootApplication;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SpringBootApplication</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RabbitMQConsumerMainType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        SpringApplication.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(RabbitMQConsumerMainType.class, args);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="四、消费端监听器" tabindex="-1">四、消费端监听器 <a class="header-anchor" href="#四、消费端监听器" aria-label="Permalink to &quot;四、消费端监听器&quot;">​</a></h2><h3 id="_1、创建监听器类" tabindex="-1">1、创建监听器类 <a class="header-anchor" href="#_1、创建监听器类" aria-label="Permalink to &quot;1、创建监听器类&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.at.mq.listener;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.rabbitmq.client.Channel;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.core.Message;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Component;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Component</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyMessageListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String EXCHANGE_DIRECT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;exchange.direct.order&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String ROUTING_KEY </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;order&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String QUEUE_NAME  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;queue.order&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">dataString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Message </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Channel </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">channel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_2、在接收消息的方法上应用注解" tabindex="-1">2、在接收消息的方法上应用注解 <a class="header-anchor" href="#_2、在接收消息的方法上应用注解" aria-label="Permalink to &quot;2、在接收消息的方法上应用注解&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 修饰监听方法</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RabbitListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 设置绑定关系</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        bindings</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">QueueBinding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 配置队列信息：durable 为 true 表示队列持久化；autoDelete 设置为 false 表示关闭自动删除</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Queue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> QUEUE_NAME, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">durable</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;true&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">autoDelete</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;false&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 配置交换机信息：durable 为 true 表示队列持久化；autoDelete 设置为 false 表示关闭自动删除</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            exchange</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Exchange</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EXCHANGE_DIRECT, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">durable</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;true&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">autoDelete</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;false&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 配置路由键信息</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {ROUTING_KEY}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String dataString, Message message, Channel channel) {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_3、接收消息方法内部逻辑" tabindex="-1">3、接收消息方法内部逻辑 <a class="header-anchor" href="#_3、接收消息方法内部逻辑" aria-label="Permalink to &quot;3、接收消息方法内部逻辑&quot;">​</a></h3><ul><li>业务处理成功：手动返回ACK信息，表示消息成功消费</li><li>业务处理失败：手动返回NACK信息，表示消息消费失败。此时有两种后续操作供选择： <ul><li>把消息重新放回消息队列，RabbitMQ会重新投递这条消息，那么消费端将重新消费这条消息——从而让业务代码再执行一遍</li><li>不把消息放回消息队列，返回reject信息表示拒绝，那么这条消息的处理就到此为止</li></ul></li></ul><h3 id="_4、相关api" tabindex="-1">4、相关API <a class="header-anchor" href="#_4、相关api" aria-label="Permalink to &quot;4、相关API&quot;">​</a></h3><p>先回到PPT理解“deliveryTag：交付标签机制”</p><p>下面我们探讨的三个方法都是来自于com.rabbitmq.client.<span style="color:blue;font-weight:bolder;">Channel</span>接口</p><h4 id="_1basicack-方法" tabindex="-1">①basicAck()方法 <a class="header-anchor" href="#_1basicack-方法" aria-label="Permalink to &quot;①basicAck()方法&quot;">​</a></h4><ul><li>方法功能：给Broker返回ACK确认信息，表示消息已经在消费端成功消费，这样Broker就可以把消息删除了</li><li>参数列表：</li></ul><table tabindex="0"><thead><tr><th>参数名称</th><th>含义</th></tr></thead><tbody><tr><td>long deliveryTag</td><td>Broker给每一条进入队列的消息都设定一个唯一标识</td></tr><tr><td>boolean multiple</td><td>取值为true：为小于、等于deliveryTag的消息批量返回ACK信息<br>取值为false：仅为指定的deliveryTag返回ACK信息</td></tr></tbody></table><h4 id="_2basicnack-方法" tabindex="-1">②basicNack()方法 <a class="header-anchor" href="#_2basicnack-方法" aria-label="Permalink to &quot;②basicNack()方法&quot;">​</a></h4><ul><li>方法功能：给Broker返回NACK信息，表示消息在消费端消费失败，此时Broker的后续操作取决于参数requeue的值</li><li>参数列表：</li></ul><table tabindex="0"><thead><tr><th>参数名称</th><th>含义</th></tr></thead><tbody><tr><td>long deliveryTag</td><td>Broker给每一条进入队列的消息都设定一个唯一标识</td></tr><tr><td>boolean multiple</td><td>取值为true：为小于、等于deliveryTag的消息批量返回ACK信息<br>取值为false：仅为指定的deliveryTag返回ACK信息</td></tr><tr><td>boolean requeue</td><td>取值为true：Broker将消息重新放回队列，接下来会重新投递给消费端<br>取值为false：Broker将消息标记为已消费，不会放回队列</td></tr></tbody></table><h4 id="_3basicreject-方法" tabindex="-1">③basicReject()方法 <a class="header-anchor" href="#_3basicreject-方法" aria-label="Permalink to &quot;③basicReject()方法&quot;">​</a></h4><ul><li>方法功能：根据指定的deliveryTag，对该消息表示拒绝</li><li>参数列表：</li></ul><table tabindex="0"><thead><tr><th>参数名称</th><th>含义</th></tr></thead><tbody><tr><td>long deliveryTag</td><td>Broker给每一条进入队列的消息都设定一个唯一标识</td></tr><tr><td>boolean requeue</td><td>取值为true：Broker将消息重新放回队列，接下来会重新投递给消费端<br>取值为false：Broker将消息标记为已消费，不会放回队列</td></tr></tbody></table><ul><li>basicNack()和basicReject()有啥区别？ <ul><li>basicNack()有批量操作</li><li>basicReject()没有批量操作</li></ul></li></ul><h3 id="_5、完整代码示例" tabindex="-1">5、完整代码示例 <a class="header-anchor" href="#_5、完整代码示例" aria-label="Permalink to &quot;5、完整代码示例&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.at.mq.listener;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.rabbitmq.client.Channel;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lombok.extern.slf4j.Slf4j;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.core.Message;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.rabbit.annotation.Exchange;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.rabbit.annotation.Queue;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.rabbit.annotation.QueueBinding;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.rabbit.annotation.RabbitListener;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Component;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.io.IOException;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Component</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Slf4j</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyMessageListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String EXCHANGE_DIRECT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;exchange.direct.order&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String ROUTING_KEY </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;order&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String QUEUE_NAME  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;queue.order&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 修饰监听方法</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RabbitListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 设置绑定关系</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            bindings</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">QueueBinding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // 配置队列信息：durable 为 true 表示队列持久化；autoDelete 为 false 表示关闭自动删除</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Queue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> QUEUE_NAME, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">durable</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;true&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">autoDelete</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;false&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // 配置交换机信息：durable 为 true 表示队列持久化；autoDelete 为 false 表示关闭自动删除</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                exchange</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Exchange</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EXCHANGE_DIRECT, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">durable</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;true&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">autoDelete</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;false&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // 配置路由键信息</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {ROUTING_KEY}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">dataString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Message </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Channel </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">channel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> IOException {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 1、获取当前消息的 deliveryTag 值备用</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> deliveryTag </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> message.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getMessageProperties</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getDeliveryTag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 2、正常业务操作</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;消费端接收到消息内容：&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dataString);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // System.out.println(10 / 0);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 3、给 RabbitMQ 服务器返回 ACK 确认信息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            channel.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">basicAck</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(deliveryTag, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Exception </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 4、获取信息，看当前消息是否曾经被投递过</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            Boolean redelivered </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> message.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getMessageProperties</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getRedelivered</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">redelivered) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // 5、如果没有被投递过，那就重新放回队列，重新投递，再试一次</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                channel.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">basicNack</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(deliveryTag, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // 6、如果已经被投递过，且这一次仍然进入了 catch 块，那么返回拒绝且不再放回队列</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                channel.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">basicReject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(deliveryTag, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="五、要点总结" tabindex="-1">五、要点总结 <a class="header-anchor" href="#五、要点总结" aria-label="Permalink to &quot;五、要点总结&quot;">​</a></h2><ul><li>要点1：把消息确认模式改为<span style="color:blue;font-weight:bold;">手动确认</span></li><li>要点2：调用Channel对象的方法返回信息 <ul><li>ACK：Acknowledgement，表示消息处理成功</li><li>NACK：Negative Acknowledgement，表示消息处理失败</li><li>Reject：拒绝，同样表示消息处理失败</li></ul></li><li>要点3：后续操作 <ul><li>requeue为true：重新放回队列，重新投递，再次尝试</li><li>requeue为false：不放回队列，不重新投递</li></ul></li><li>要点4：deliveryTag 消息的唯一标识，查找具体某一条消息的依据</li></ul><h2 id="六、流程梳理" tabindex="-1">六、流程梳理 <a class="header-anchor" href="#六、流程梳理" aria-label="Permalink to &quot;六、流程梳理&quot;">​</a></h2><p><img src="`+ys+'" alt="未命名文件"></p><h2 id="七、多啰嗦一句" tabindex="-1">七、多啰嗦一句 <a class="header-anchor" href="#七、多啰嗦一句" aria-label="Permalink to &quot;七、多啰嗦一句&quot;">​</a></h2><p>消费端如果设定消息重新放回队列，Broker重新投递消息，那么消费端就可以再次消费消息，这是一种“重试”机制，这需要消费端代码支持“<span style="color:blue;font-weight:bold;">幂等性</span>”——这属于前置知识，不展开了。</p><h1 id="消息百分百成功投递" tabindex="-1">消息百分百成功投递 <a class="header-anchor" href="#消息百分百成功投递" aria-label="Permalink to &quot;消息百分百成功投递&quot;">​</a></h1><h1 id="_1-消息百分百成功投递" tabindex="-1">1 消息百分百成功投递 <a class="header-anchor" href="#_1-消息百分百成功投递" aria-label="Permalink to &quot;1 消息百分百成功投递&quot;">​</a></h1><p>谈到消息的可靠性投递，无法避免的，在实际的工作中会经常碰到，比如一些核心业务需要保障消息不丢失，接下来我们看一个可靠性投递的流程图，说明可靠性投递的概念：</p><p><img src="'+Fs+'" alt="img"></p><p>Step 1： 首先把消息信息(业务数据）存储到数据库中，紧接着，我们再把这个消息记录也存储到一张消息记录表里（或者另外一个同源数据库的消息记录表）</p><p>Step 2：发送消息到MQ Broker节点（采用confirm方式发送，会有异步的返回结果）</p><p>Step 3、4：生产者端接受MQ Broker节点返回的Confirm确认消息结果，然后进行更新消息记录表里的消息状态。比如默认Status = 0 当收到消息确认成功后，更新为1即可！</p><p>Step 5：但是在消息确认这个过程中可能由于网络闪断、MQ Broker端异常等原因导致 回送消息失败或者异常。这个时候就需要发送方（生产者）对消息进行可靠性投递了，保障消息不丢失，100%的投递成功！（有一种极限情况是闪断，Broker返回的成功确认消息，但是生产端由于网络闪断没收到，这个时候重新投递可能会造成消息重复，需要消费端去做幂等处理）所以我们需要有一个定时任务，（比如每5分钟拉取一下处于中间状态的消息，当然这个消息可以设置一个超时时间，比如超过1分钟 Status = 0 ，也就说明了1分钟这个时间窗口内，我们的消息没有被确认，那么会被定时任务拉取出来）</p><p>Step 6：接下来我们把中间状态的消息进行重新投递 retry send，继续发送消息到MQ ，当然也可能有多种原因导致发送失败</p><p>Step 7：我们可以采用设置最大努力尝试次数，比如投递了3次，还是失败，那么我们可以将最终状态设置为Status = 2 ，最后 交由人工解决处理此类问题（或者把消息转储到失败表中）。</p><h1 id="_2-消息幂等性保障" tabindex="-1">2 消息幂等性保障 <a class="header-anchor" href="#_2-消息幂等性保障" aria-label="Permalink to &quot;2 消息幂等性保障&quot;">​</a></h1><p>幂等性指一次和多次请求某一个资源，对于资源本身应该具有同样的结果。也就是说，其任意多次执行对资源本身所产生的影响均与一次执行的影响相同。</p><p><img src="'+us+`" alt="img"></p><p>在MQ中指，消费多条相同的消息，得到与消费该消息一次相同的结果。</p><p><strong>消息幂等性保障 乐观锁机制</strong></p><p>生产者发送消息：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">money=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">version=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span></code></pre></div><p>消费者接收消息</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">money=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">version=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">money=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">version=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span></code></pre></div><p>消费者需要保证幂等性：第一次执行SQL语句</p><p>第一次执行：version=1</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> account </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">set</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> money</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> money</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> , </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">where</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> and</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span></code></pre></div><p>消费者需要保证幂等性：第二次执行SQL语句</p><p>第二次执行：version=2</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> account </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">set</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> money</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> money</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> , </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">where</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> and</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span></code></pre></div><h1 id="消费端限流" tabindex="-1">消费端限流 <a class="header-anchor" href="#消费端限流" aria-label="Permalink to &quot;消费端限流&quot;">​</a></h1><h1 id="一、概述-1" tabindex="-1">一、概述 <a class="header-anchor" href="#一、概述-1" aria-label="Permalink to &quot;一、概述&quot;">​</a></h1><p><img src="`+bs+`" alt="image-20240806094300945"></p><ul><li>生产者发送10000个消息</li><li>消费端并发能力上限：同时处理1000个请求</li><li>设定：</li></ul><p>​ 每次最多从队列取回1000个请求</p><h1 id="二、生产者端代码" tabindex="-1">二、生产者端代码 <a class="header-anchor" href="#二、生产者端代码" aria-label="Permalink to &quot;二、生产者端代码&quot;">​</a></h1><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> testSendMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        rabbitTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">convertAndSend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                EXCHANGE_DIRECT,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                ROUTING_KEY,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                &quot;Hello at&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h1 id="三、消费者端代码" tabindex="-1">三、消费者端代码 <a class="header-anchor" href="#三、消费者端代码" aria-label="Permalink to &quot;三、消费者端代码&quot;">​</a></h1><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 2、正常业务操作</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;消费端接收到消息内容：&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dataString);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// System.out.println(10 / 0);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TimeUnit.SECONDS.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sleep</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 3、给 RabbitMQ 服务器返回 ACK 确认信息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">channel.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">basicAck</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(deliveryTag, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h1 id="四、测试" tabindex="-1">四、测试 <a class="header-anchor" href="#四、测试" aria-label="Permalink to &quot;四、测试&quot;">​</a></h1><h2 id="_1、未使用prefetch" tabindex="-1">1、未使用prefetch <a class="header-anchor" href="#_1、未使用prefetch" aria-label="Permalink to &quot;1、未使用prefetch&quot;">​</a></h2><ul><li>不要启动消费端程序，如果正在运行就把它停了</li><li>运行生产者端程序发送100条消息</li><li>查看队列中消息的情况：</li></ul><p><img src="`+As+'" alt="image-20231107155915253"></p><ul><li><p>说明：</p><ul><li>Ready表示已经发送到队列的消息数量</li><li>Unacked表示已经发送到消费端但是消费端尚未返回ACK信息的消息数量</li><li>Total未被删除的消息总数</li></ul></li><li><p>接下来启动消费端程序，再查看队列情况：</p></li></ul><p><img src="'+ms+`" alt="image-20231107160233539"></p><ul><li>能看到消息全部被消费端取走了，正在逐个处理、确认，说明有多少消息消费端就并发处理多少</li></ul><h2 id="_2、设定prefetch" tabindex="-1">2、设定prefetch <a class="header-anchor" href="#_2、设定prefetch" aria-label="Permalink to &quot;2、设定prefetch&quot;">​</a></h2><h3 id="_1yaml配置" tabindex="-1">①YAML配置 <a class="header-anchor" href="#_1yaml配置" aria-label="Permalink to &quot;①YAML配置&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  rabbitmq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    host</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168.200.100</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5672</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    username</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">guest</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    password</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">123456</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    virtual-host</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    listener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      simple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        acknowledge-mode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">manual</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        prefetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 设置每次最多从消息队列服务器取回多少消息</span></span></code></pre></div><h3 id="_2测试流程" tabindex="-1">②测试流程 <a class="header-anchor" href="#_2测试流程" aria-label="Permalink to &quot;②测试流程&quot;">​</a></h3><ul><li>停止消费端程序</li><li>运行生产者端程序发送100条消息</li><li>查看队列中消息的情况：</li></ul><p><img src="`+Cs+'" alt="image-20231107160820062"></p><ul><li>接下来启动消费端程序，持续观察队列情况：</li></ul><p><img src="'+Ds+'" alt="image-20231107160922632"></p><p><img src="'+qs+'" alt="image-20231107160936216"></p><p><img src="'+Bs+'" alt="image-20231107160951639"></p><ul><li>能看到消息不是一次性全部取走的，而是有个过程</li></ul><h1 id="消息超时" tabindex="-1">消息超时 <a class="header-anchor" href="#消息超时" aria-label="Permalink to &quot;消息超时&quot;">​</a></h1><h1 id="_1-概述-1" tabindex="-1">1 概述 <a class="header-anchor" href="#_1-概述-1" aria-label="Permalink to &quot;1 概述&quot;">​</a></h1><p>TTL 全称 Time To Live（存活时间/过期时间）。</p><p>当消息到达存活时间后，还没有被消费，会被自动清除。</p><p>RabbitMQ可以对消息设置过期时间，也可以对整个队列（Queue）设置过期时间。</p><p><img src="'+vs+'" alt="image-20240806094631068"></p><h1 id="_2-具体实现" tabindex="-1">2 具体实现 <a class="header-anchor" href="#_2-具体实现" aria-label="Permalink to &quot;2 具体实现&quot;">​</a></h1><h2 id="一、队列层面设置" tabindex="-1">一、队列层面设置 <a class="header-anchor" href="#一、队列层面设置" aria-label="Permalink to &quot;一、队列层面设置&quot;">​</a></h2><h3 id="_1、设置" tabindex="-1">1、设置 <a class="header-anchor" href="#_1、设置" aria-label="Permalink to &quot;1、设置&quot;">​</a></h3><p><img src="'+fs+'" alt="image-20231107162548129"></p><p>别忘了设置绑定关系：</p><p><img src="'+_s+'" alt="image-20231107162705883"></p><h3 id="_2、测试" tabindex="-1">2、测试 <a class="header-anchor" href="#_2、测试" aria-label="Permalink to &quot;2、测试&quot;">​</a></h3><ul><li>不启动消费端程序</li><li>向设置了过期时间的队列中发送100条消息</li><li>等10秒后，看是否全部被过期删除</li></ul><p><img src="'+xs+`" alt="image-20231107163052001"></p><h2 id="二、消息层面设置" tabindex="-1">二、消息层面设置 <a class="header-anchor" href="#二、消息层面设置" aria-label="Permalink to &quot;二、消息层面设置&quot;">​</a></h2><h3 id="_1、设置-1" tabindex="-1">1、设置 <a class="header-anchor" href="#_1、设置-1" aria-label="Permalink to &quot;1、设置&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.core.Message;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.core.MessagePostProcessor;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> testSendMessageTTL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1、创建消息后置处理器对象  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    MessagePostProcessor messagePostProcessor </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Message message) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 设定 TTL 时间，以毫秒为单位</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        message.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getMessageProperties</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setExpiration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;5000&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> message;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2、发送消息  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    rabbitTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">convertAndSend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            EXCHANGE_DIRECT,     </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            ROUTING_KEY,     </span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            &quot;Hello at&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, messagePostProcessor);    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_2、查看效果" tabindex="-1">2、查看效果 <a class="header-anchor" href="#_2、查看效果" aria-label="Permalink to &quot;2、查看效果&quot;">​</a></h3><p>这次我们是发送到普通队列上：</p><p><img src="`+Ps+'" alt="image-20231107163534385"></p><h1 id="死信队列" tabindex="-1">死信队列 <a class="header-anchor" href="#死信队列" aria-label="Permalink to &quot;死信队列&quot;">​</a></h1><h1 id="_1-概述-2" tabindex="-1">1 概述 <a class="header-anchor" href="#_1-概述-2" aria-label="Permalink to &quot;1 概述&quot;">​</a></h1><h2 id="_1-1-什么是死信队列" tabindex="-1">1.1 什么是死信队列 <a class="header-anchor" href="#_1-1-什么是死信队列" aria-label="Permalink to &quot;1.1 什么是死信队列&quot;">​</a></h2><p>死信队列，英文缩写：DLX 。DeadLetter Exchange（死信交换机），当消息成为Dead message后，可以被重新发送到另一个交换机，这个交换机就是DLX。</p><p><img src="'+Ms+'" alt="image-20240806095014641"></p><p>先从概念解释上搞清楚这个定义，死信，顾名思义就是无法被消费的消息，字面意思可以这样理解，一般来说，producer将消息投递到broker或者直接到queue里了，consumer从queue取出消息进行消费，但某些时候由于特定的原因导致queue中的某些消息无法被消费，这样的消息如果没有后续的处理，就变成了死信，有死信，自然就有了死信队列；</p><h2 id="_1-2-消息成为死信的三种情况" tabindex="-1">1.2 <strong>消息成为死信的三种情况</strong> <a class="header-anchor" href="#_1-2-消息成为死信的三种情况" aria-label="Permalink to &quot;1.2 **消息成为死信的三种情况**&quot;">​</a></h2><ul><li>**拒绝：**消费者拒接消息，basicNack()/basicReject()，并且不把消息重新放入原目标队列，requeue=false</li><li>**溢出：**队列中消息数量到达限制。比如队列最大只能存储10条消息，且现在已经存储了10条，此时如果再发送一条消息进来，根据先进先出原则，队列中最早的消息会变成死信</li><li>**超时：**消息到达超时时间未被消费</li></ul><h2 id="_1-3-死信的处理方式" tabindex="-1">1.3 死信的处理方式 <a class="header-anchor" href="#_1-3-死信的处理方式" aria-label="Permalink to &quot;1.3 死信的处理方式&quot;">​</a></h2><p>死信的产生既然不可避免，那么就需要从实际的业务角度和场景出发，对这些死信进行后续的处理，常见的处理方式大致有下面几种，</p><p>**① 丢弃，**如果不是很重要，可以选择丢弃</p><p>**② 记录死信入库，**然后做后续的业务分析或处理</p><p>**③ 通过死信队列，**由负责监听死信的应用程序进行处理</p><p>综合来看，更常用的做法是第三种，即通过死信队列，将产生的死信通过程序的配置路由到指定的死信队列，然后应用监听死信队列，对接收到的死信做后续的处理</p><h1 id="_2-实现" tabindex="-1">2 实现 <a class="header-anchor" href="#_2-实现" aria-label="Permalink to &quot;2 实现&quot;">​</a></h1><h2 id="一、测试相关准备" tabindex="-1">一、测试相关准备 <a class="header-anchor" href="#一、测试相关准备" aria-label="Permalink to &quot;一、测试相关准备&quot;">​</a></h2><h3 id="_1、创建死信交换机和死信队列" tabindex="-1">1、创建死信交换机和死信队列 <a class="header-anchor" href="#_1、创建死信交换机和死信队列" aria-label="Permalink to &quot;1、创建死信交换机和死信队列&quot;">​</a></h3><p>常规设定即可，没有特殊设置：</p><ul><li>死信交换机：exchange.dead.letter.video</li><li>死信队列：queue.dead.letter.video</li><li>死信路由键：routing.key.dead.letter.video</li></ul><h3 id="_2、创建正常交换机和正常队列" tabindex="-1">2、创建正常交换机和正常队列 <a class="header-anchor" href="#_2、创建正常交换机和正常队列" aria-label="Permalink to &quot;2、创建正常交换机和正常队列&quot;">​</a></h3><p><span style="color:blue;font-weight:bolder;">注意</span>：一定要注意正常队列有诸多限定和设置，这样才能让无法处理的消息进入死信交换机</p><p><img src="'+Rs+'" alt="image-20240318165821774"></p><ul><li>正常交换机：exchange.normal.video</li><li>正常队列：queue.normal.video</li><li>正常路由键：routing.key.normal.video</li></ul><p>全部设置完成后参照如下细节：</p><p><img src="'+Ts+`" alt="image-20240318165927279"></p><h3 id="_3、java代码中的相关常量声明" tabindex="-1">3、Java代码中的相关常量声明 <a class="header-anchor" href="#_3、java代码中的相关常量声明" aria-label="Permalink to &quot;3、Java代码中的相关常量声明&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String EXCHANGE_NORMAL </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;exchange.normal.video&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String EXCHANGE_DEAD_LETTER </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;exchange.dead.letter.video&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String ROUTING_KEY_NORMAL </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;routing.key.normal.video&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String ROUTING_KEY_DEAD_LETTER </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;routing.key.dead.letter.video&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String QUEUE_NORMAL </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;queue.normal.video&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String QUEUE_DEAD_LETTER </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;queue.dead.letter.video&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><h2 id="二、消费端拒收消息" tabindex="-1">二、消费端拒收消息 <a class="header-anchor" href="#二、消费端拒收消息" aria-label="Permalink to &quot;二、消费端拒收消息&quot;">​</a></h2><h3 id="_1、发送消息的代码" tabindex="-1">1、发送消息的代码 <a class="header-anchor" href="#_1、发送消息的代码" aria-label="Permalink to &quot;1、发送消息的代码&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> testSendMessageButReject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    rabbitTemplate  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">convertAndSend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    EXCHANGE_NORMAL,  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    ROUTING_KEY_NORMAL,  </span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                    &quot;测试死信情况1：消息被拒绝&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_2、接收消息的代码" tabindex="-1">2、接收消息的代码 <a class="header-anchor" href="#_2、接收消息的代码" aria-label="Permalink to &quot;2、接收消息的代码&quot;">​</a></h3><h4 id="_1监听正常队列" tabindex="-1">①监听正常队列 <a class="header-anchor" href="#_1监听正常队列" aria-label="Permalink to &quot;①监听正常队列&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RabbitListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">queues</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {QUEUE_NORMAL})</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processMessageNormal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Message message, Channel channel) throws IOException {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 监听正常队列，但是拒绝消息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;★[normal]消息接收到，但我拒绝。&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    channel.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">basicReject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(message.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getMessageProperties</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getDeliveryTag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h4 id="_2监听死信队列" tabindex="-1">②监听死信队列 <a class="header-anchor" href="#_2监听死信队列" aria-label="Permalink to &quot;②监听死信队列&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RabbitListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">queues</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {QUEUE_DEAD_LETTER})</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processMessageDead</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String dataString, Message message, Channel channel) throws IOException {  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 监听死信队列  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;★[dead letter]dataString = &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dataString);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;★[dead letter]我是死信监听方法，我接收到了死信消息&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    channel.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">basicAck</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(message.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getMessageProperties</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getDeliveryTag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_3、执行结果" tabindex="-1">3、执行结果 <a class="header-anchor" href="#_3、执行结果" aria-label="Permalink to &quot;3、执行结果&quot;">​</a></h3><p><img src="`+ws+`" alt="image-20231107170523503"></p><h2 id="三、消息数量超过队列容纳极限" tabindex="-1">三、消息数量超过队列容纳极限 <a class="header-anchor" href="#三、消息数量超过队列容纳极限" aria-label="Permalink to &quot;三、消息数量超过队列容纳极限&quot;">​</a></h2><h3 id="_1、发送消息的代码-1" tabindex="-1">1、发送消息的代码 <a class="header-anchor" href="#_1、发送消息的代码-1" aria-label="Permalink to &quot;1、发送消息的代码&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> testSendMultiMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        rabbitTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">convertAndSend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                EXCHANGE_NORMAL,  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                ROUTING_KEY_NORMAL,  </span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                &quot;测试死信情况2：消息数量超过队列的最大容量&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i);  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_2、接收消息的代码-1" tabindex="-1">2、接收消息的代码 <a class="header-anchor" href="#_2、接收消息的代码-1" aria-label="Permalink to &quot;2、接收消息的代码&quot;">​</a></h3><p>消息接收代码不再拒绝消息：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RabbitListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">queues</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {QUEUE_NORMAL})</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processMessageNormal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Message message, Channel channel) throws IOException {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 监听正常队列</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;★[normal]消息接收到。&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    channel.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">basicAck</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(message.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getMessageProperties</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getDeliveryTag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>重启微服务使代码修改生效。</p><h3 id="_3、执行效果" tabindex="-1">3、执行效果 <a class="header-anchor" href="#_3、执行效果" aria-label="Permalink to &quot;3、执行效果&quot;">​</a></h3><p>正常队列的参数如下图所示：</p><p><img src="`+Qs+'" alt="image-20231107171231765"></p><p>生产者发送20条消息之后，消费端死信队列接收到前10条消息：</p><p><img src="'+Ss+`" alt="images"></p><h2 id="四、消息超时未消费" tabindex="-1">四、消息超时未消费 <a class="header-anchor" href="#四、消息超时未消费" aria-label="Permalink to &quot;四、消息超时未消费&quot;">​</a></h2><h3 id="_1、发送消息的代码-2" tabindex="-1">1、发送消息的代码 <a class="header-anchor" href="#_1、发送消息的代码-2" aria-label="Permalink to &quot;1、发送消息的代码&quot;">​</a></h3><p>正常发送一条消息即可，所以使用第一个例子的代码。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Test</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> testSendMessageTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    rabbitTemplate</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">convertAndSend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    EXCHANGE_NORMAL,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    ROUTING_KEY_NORMAL,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                    &quot;测试死信情况3：消息超时&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_2、执行效果" tabindex="-1">2、执行效果 <a class="header-anchor" href="#_2、执行效果" aria-label="Permalink to &quot;2、执行效果&quot;">​</a></h3><p>队列参数生效：</p><p><img src="`+Is+'" alt="image-20231107172002297"></p><p>因为没有消费端监听程序，所以消息未超时前滞留在队列中：</p><p><img src="'+js+'" alt="image-20231107172234849"></p><p>消息超时后，进入死信队列：</p><p><img src="'+Ns+'" alt="image-20231107172042460"></p><h1 id="延迟队列" tabindex="-1">延迟队列 <a class="header-anchor" href="#延迟队列" aria-label="Permalink to &quot;延迟队列&quot;">​</a></h1><h1 id="_1-概述-3" tabindex="-1">1 概述 <a class="header-anchor" href="#_1-概述-3" aria-label="Permalink to &quot;1 概述&quot;">​</a></h1><ul><li><p>延迟队列存储的对象肯定是对应的延时消息，所谓”延时消息”是指当消息被发送以后，并不想让消费者立即拿到消息，而是等待指定时间后，消费者才拿到这个消息进行消费。</p></li><li><p>场景：在订单系统中，一个用户下单之后通常有30分钟的时间进行支付，如果30分钟之内没有支付成功，那么这个订单将进行取消处理。这时就可以使用延时队列将订单信息发送到延时队列。</p></li><li><p>需求：</p></li></ul><ol><li><p>下单后，30分钟未支付，取消订单，回滚库存。</p></li><li><p>新用户注册成功30分钟后，发送短信问候。</p></li></ol><ul><li>实现：</li></ul><p>使用延迟队列实现</p><p><img src="'+Us+'" alt="image-20240806095835083"></p><p>很可惜，在RabbitMQ中并未提供延迟队列功能</p><p>我们可以采用以下方案实现：</p><p>方案1：借助消息超时时间+死信队列</p><p>方案2：给RabbitMQ安装插件</p><p><img src="'+Os+`" alt="image-20240806100015448"></p><p>注：使用消息超时时间+死信队列，前面已经演示过了</p><h1 id="_2-延迟插件" tabindex="-1">2 延迟插件 <a class="header-anchor" href="#_2-延迟插件" aria-label="Permalink to &quot;2 延迟插件&quot;">​</a></h1><h2 id="一、插件简介" tabindex="-1">一、插件简介 <a class="header-anchor" href="#一、插件简介" aria-label="Permalink to &quot;一、插件简介&quot;">​</a></h2><ul><li>官网地址：<a href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange" target="_blank" rel="noreferrer">https://github.com/rabbitmq/rabbitmq-delayed-message-exchange</a></li><li>延迟极限：最多两天</li><li>插件使用注意事项： <ul><li>插件版本必须与RabbitMQ版本一致</li><li>延迟消息会触发回退回调函数执行。</li><li>保证消息顺序一致。</li></ul></li></ul><h2 id="二、插件安装" tabindex="-1">二、插件安装 <a class="header-anchor" href="#二、插件安装" aria-label="Permalink to &quot;二、插件安装&quot;">​</a></h2><h3 id="_1、确定卷映射目录" tabindex="-1">1、确定卷映射目录 <a class="header-anchor" href="#_1、确定卷映射目录" aria-label="Permalink to &quot;1、确定卷映射目录&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> inspect</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rabbitmq</span></span></code></pre></div><p>运行结果：</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;Mounts&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                &quot;Type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;volume&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                &quot;Name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;rabbitmq-plugin&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                &quot;Source&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/var/lib/docker/volumes/rabbitmq-plugin/_data&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                &quot;Destination&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/plugins&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                &quot;Driver&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;local&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                &quot;Mode&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;z&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                &quot;RW&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                &quot;Propagation&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                &quot;Type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;volume&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                &quot;Name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cca7bc3012f5b76bd6c47a49ca6911184f9076f5f6263b41f4b9434a7f269b11&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                &quot;Source&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/var/lib/docker/volumes/cca7bc3012f5b76bd6c47a49ca6911184f9076f5f6263b41f4b9434a7f269b11/_data&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                &quot;Destination&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/var/lib/rabbitmq&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                &quot;Driver&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;local&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                &quot;Mode&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                &quot;RW&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                &quot;Propagation&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ]</span></span></code></pre></div><p>和容器内/plugins目录对应的宿主机目录是：/var/lib/docker/volumes/rabbitmq-plugin/_data</p><h3 id="_2、下载延迟插件" tabindex="-1">2、下载延迟插件 <a class="header-anchor" href="#_2、下载延迟插件" aria-label="Permalink to &quot;2、下载延迟插件&quot;">​</a></h3><p>官方文档说明页地址：<a href="https://www.rabbitmq.com/community-plugins.html" target="_blank" rel="noreferrer">https://www.rabbitmq.com/community-plugins.html</a></p><p><img src="`+Ks+`" alt="image-20231107180045135"></p><p>下载插件安装文件：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wget</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/download/v3.12.0/rabbitmq_delayed_message_exchange-3.12.0.ez</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mv</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rabbitmq_delayed_message_exchange-3.12.0.ez</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/docker/volumes/rabbitmq-plugin/_data</span></span></code></pre></div><h3 id="_3、启用插件" tabindex="-1">3、启用插件 <a class="header-anchor" href="#_3、启用插件" aria-label="Permalink to &quot;3、启用插件&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 登录进入容器内部</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -it</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rabbitmq</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># rabbitmq-plugins命令所在目录已经配置到$PATH环境变量中了，可以直接调用</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rabbitmq-plugins</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enable</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rabbitmq_delayed_message_exchange</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 退出Docker容器</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 重启Docker容器</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rabbitmq</span></span></code></pre></div><h3 id="_4、确认" tabindex="-1">4、确认 <a class="header-anchor" href="#_4、确认" aria-label="Permalink to &quot;4、确认&quot;">​</a></h3><p>确认点1：查看当前节点已启用插件的列表：Overview-&gt;Nodes-&gt;Advanced-&gt;Plugins</p><p><img src="`+Gs+'" alt="image-20240321115348525"></p><p>确认点2：如果创建新交换机时可以在type中看到x-delayed-message选项，那就说明插件安装好了</p><p><img src="'+Ls+'" alt="image-20231107181914265"></p><h2 id="三、创建交换机" tabindex="-1">三、创建交换机 <a class="header-anchor" href="#三、创建交换机" aria-label="Permalink to &quot;三、创建交换机&quot;">​</a></h2><p>rabbitmq_delayed_message_exchange插件在工作时要求交换机是<span style="color:blue;font-weight:bolder;">x-delayed-message</span>类型才可以，创建方式如下：</p><p><img src="'+Ys+`" alt="image-20240319163915574"></p><p>关于<span style="color:blue;font-weight:bolder;">x-delayed-type</span>参数的理解：</p><blockquote><p>原本指定交换机类型的地方使用了x-delayed-message这个值，那么这个交换机除了支持延迟消息之外，到底是direct、fanout、topic这些类型中的哪一个呢？</p><p>这里就额外使用x-delayed-type来指定交换机本身的类型</p></blockquote><h2 id="四、代码测试" tabindex="-1">四、代码测试 <a class="header-anchor" href="#四、代码测试" aria-label="Permalink to &quot;四、代码测试&quot;">​</a></h2><h3 id="_1、生产者端代码" tabindex="-1">1、生产者端代码 <a class="header-anchor" href="#_1、生产者端代码" aria-label="Permalink to &quot;1、生产者端代码&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Test</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> testSendDelayMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    rabbitTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">convertAndSend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            EXCHANGE_DELAY,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            ROUTING_KEY_DELAY,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            &quot;测试基于插件的延迟消息 [&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SimpleDateFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;hh:mm:ss&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">format</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Date</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;]&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            messageProcessor </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // 设置延迟时间：以毫秒为单位</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                messageProcessor.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getMessageProperties</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setHeader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;x-delay&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;10000&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> messageProcessor;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_2、消费者端代码" tabindex="-1">2、消费者端代码 <a class="header-anchor" href="#_2、消费者端代码" aria-label="Permalink to &quot;2、消费者端代码&quot;">​</a></h3><h4 id="_1情况a-资源已创建" tabindex="-1">①情况A：资源已创建 <a class="header-anchor" href="#_1情况a-资源已创建" aria-label="Permalink to &quot;①情况A：资源已创建&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.at.mq.listener;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.rabbitmq.client.Channel;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lombok.extern.slf4j.Slf4j;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.core.Message;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.rabbit.annotation.RabbitListener;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Component;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.io.IOException;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.text.SimpleDateFormat;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.Date;  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Component</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Slf4j</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyDelayMessageListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String QUEUE_DELAY </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;queue.delay.video&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RabbitListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">queues</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {QUEUE_DELAY})</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> process</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">dataString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,Message </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,Channel </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">channel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> IOException {  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;[生产者]&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dataString);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;[消费者]&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SimpleDateFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;hh:mm:ss&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">format</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Date</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        channel.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">basicAck</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(message.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getMessageProperties</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getDeliveryTag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h4 id="_2情况b-资源未创建" tabindex="-1">②情况B：资源未创建 <a class="header-anchor" href="#_2情况b-资源未创建" aria-label="Permalink to &quot;②情况B：资源未创建&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.at.mq.listener;  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.rabbitmq.client.Channel;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lombok.extern.slf4j.Slf4j;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.core.Message;  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.amqp.rabbit.annotation.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Component;  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.io.IOException;  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.text.SimpleDateFormat;  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.Date;  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Component</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Slf4j</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyDelayMessageListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String EXCHANGE_DELAY </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;exchange.delay.video&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String ROUTING_KEY_DELAY </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;routing.key.delay.video&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String QUEUE_DELAY </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;queue.delay.video&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RabbitListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">bindings</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">QueueBinding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(  </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Queue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> QUEUE_DELAY, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">durable</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;true&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">autoDelete</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;false&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),  </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        exchange</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Exchange</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(  </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EXCHANGE_DELAY,   </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                durable</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;true&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,   </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                autoDelete</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;false&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,   </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;x-delayed-message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,   </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                arguments</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Argument</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;x-delayed-type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;direct&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)),  </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {ROUTING_KEY_DELAY}  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ))  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> process</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">dataString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Message </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Channel </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">channel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> IOException {  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;[生产者]&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dataString);  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;[消费者]&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SimpleDateFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;hh:mm:ss&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">format</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Date</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()));  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        channel.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">basicAck</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(message.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getMessageProperties</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getDeliveryTag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_3、执行效果-1" tabindex="-1">3、执行效果 <a class="header-anchor" href="#_3、执行效果-1" aria-label="Permalink to &quot;3、执行效果&quot;">​</a></h3><h4 id="_1交换机类型" tabindex="-1">①交换机类型 <a class="header-anchor" href="#_1交换机类型" aria-label="Permalink to &quot;①交换机类型&quot;">​</a></h4><p><img src="`+Hs+'" alt="image-20240319171359652"></p><h4 id="_2生产者端效果" tabindex="-1">②生产者端效果 <a class="header-anchor" href="#_2生产者端效果" aria-label="Permalink to &quot;②生产者端效果&quot;">​</a></h4><p><span style="color:blue;font-weight:bolder;">注意</span>：使用rabbitmq_delayed_message_exchange插件后，即使消息成功发送到队列上，也会导致returnedMessage()方法执行</p><p><img src="'+Xs+'" alt="image-20240321115605608"></p><h4 id="_3消费者端效果" tabindex="-1">③消费者端效果 <a class="header-anchor" href="#_3消费者端效果" aria-label="Permalink to &quot;③消费者端效果&quot;">​</a></h4><p><img src="'+zs+'" alt="image-20240321115646548"></p>',668)]))}const ti=i(Ws,[["render",Vs]]);export{ni as __pageData,ti as default};
