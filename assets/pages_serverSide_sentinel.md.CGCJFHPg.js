import{_ as a,c as t,o as e,ao as i,j as p}from"./chunks/framework.DOhyS95j.js";const n="/handbook/assets/image-20230624203044831-16882902699931.BDClom_l.png",l="/handbook/assets/image-20230624203153340-16882902699943.DHgbER5_.png",h="/handbook/assets/image-20230624203222353-16882902699932.hWaJqCUI.png",r="/handbook/assets/image-20230624203256590-16882902699944.CmjXZNWB.png",k="/handbook/assets/image-20230624203334370-16882902699945.CEEwG785.png",o="/handbook/assets/image-20230624203409785-16882902699946.DQUyPxl7.png",d="/handbook/assets/image-20230624203508014-16882902699947.BwLLGfO4.png",g="/handbook/assets/image-20230624203655208-16882902699948.THvo8BMW.png",E="/handbook/assets/image-20230624203730680-16882902699949.DOaYlsnS.png",c="/handbook/assets/image-20230624215112184-168829026999410.DpYKidu_.png",m="/handbook/assets/image-20230624215403344-168829026999411.Dg1S1IRr.png",u="/handbook/assets/image-20230624215635555-168829026999412.BbHYBHX4.png",y="/handbook/assets/image-20230624215704921-168829026999413.B1stXJg-.png",b="/handbook/assets/image-20230624220303385-168829026999414.BYjy-NbY.png",F="/handbook/assets/image-20230624220603571-168829026999415.9D68_RGp.png",v="/handbook/assets/image-20230628090407483-168829026999416.DVgj9Nee.png",C="data:image/png;base64,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",q="/handbook/assets/image-20220320111824238-168829026999418.BCik10Dl.png",B="/handbook/assets/image-20220320111955904-168829026999419.CpzOJ30A.png",I="/handbook/assets/image-20220320112040803-168829026999420.C96Dqz_x.png",A="/handbook/assets/image-20220320112142379-168829026999421.B0t44gZc.png",S="/handbook/assets/image-20230628091856122-168829026999422.CAmRkHR0.png",R="/handbook/assets/image-20230628092034118-168829026999423.NbW5kVKo.png",D="/handbook/assets/image-20230628092515666-168829026999424.svOm1j5g.png",_="/handbook/assets/image-20230628092751648-168829026999425.D4K5aDNt.png",f="/handbook/assets/image-20220320114459422-168829026999426.B3PGGaHO.png",P="/handbook/assets/image-20230628093126793-168829026999427.CHcv8ssz.png",U="/handbook/assets/image-20230628093300378-168829026999428.Xud3F9Uh.png",x="/handbook/assets/image-20230628095013326-168829026999429.DZlyKlsc.png",j="/handbook/assets/image-20230628094306219-168829026999430.DcwzRAch.png",J="/handbook/assets/image-20230628094433574-168829026999431.DXZzgyaj.png",N="/handbook/assets/image-20220320150559229-168829026999432.BchJPLLj.png",V="/handbook/assets/image-20230628094648097-168829026999433.vlyOpvkO.png",w="/handbook/assets/image-20230628094713655-168829026999434.Dl5LLlDG.png",M="/handbook/assets/image-20230628094814795-168829026999435.DIOaq4Sy.png",T="/handbook/assets/image-20230628094857374-168829026999536.6fJjCZvX.png",G="/handbook/assets/image-20230628095109686-168829026999537.x8lTYLBG.png",Q="/handbook/assets/image-20220320152944101-168829026999538.83-BGVd9.png",L="/handbook/assets/image-20230628095505037-168829026999539.8EVYmHIl.png",W="/handbook/assets/image-20220320153409220-168829026999540.DwaYpA4P.png",z="/handbook/assets/image-20220320153522505-168829026999541.gE9HyzPv.png",H="/handbook/assets/image-20220320153646510-168829026999542.Df-vzlEM.png",Y="/handbook/assets/image-20230628095925921-168829026999543.DB4hquhi.png",O="/handbook/assets/image-20230628100019712-168829026999544.B7FlId4M.png",Z="/handbook/assets/image-20230628100049968-168829026999545.Dvv3f2eW.png",K="/handbook/assets/image-20230628100313331-168829026999546.B2ZOK-rX.png",X="/handbook/assets/image-20220320154801992-168829026999547.B_EAqmOk.png",$="/handbook/assets/image-20220320155103019-168829026999548.CexZQFwW.png",ss="/handbook/assets/image-20220320155202523-168829026999549.BLDti1Jc.png",is="/handbook/assets/image-20230628100914491-168829026999550.CeoOYVWC.png",as="/handbook/assets/image-20230628101012945-168829026999551.DrdGG5m6.png",ts="/handbook/assets/image-20230628101216576-168829026999552.BNj3KTpG.png",es="/handbook/assets/image-20230628101331468-168829026999553.B75DEQZs.png",ps="/handbook/assets/image-20230628101715773-168829026999554.B31gpZ6U.png",ns="/handbook/assets/image-20230628102031276-168829026999555.kizMjytD.png",ls="/handbook/assets/image-20220320162420189-168829026999556.Yc7Gac7R.png",hs="/handbook/assets/image-20220320162905731.BBgcgVqS.png",rs="/handbook/assets/image-20220320163002195.BSJ0v8zv.png",ks="/handbook/assets/image-20220320163023729.C3x-UQBI.png",bs=JSON.parse('{"title":"Sentinel组件","description":"","frontmatter":{},"headers":[],"relativePath":"pages/serverSide/sentinel.md","filePath":"pages/serverSide/sentinel.md","lastUpdated":1748852161000}'),os={name:"pages/serverSide/sentinel.md"};function ds(gs,s,Es,cs,ms,us){return e(),t("div",null,s[0]||(s[0]=[i('<h1 id="sentinel组件" tabindex="-1">Sentinel组件 <a class="header-anchor" href="#sentinel组件" aria-label="Permalink to &quot;Sentinel组件&quot;">​</a></h1><h2 id="初识sentinel" tabindex="-1">初识sentinel <a class="header-anchor" href="#初识sentinel" aria-label="Permalink to &quot;初识sentinel&quot;">​</a></h2><h3 id="雪崩效应" tabindex="-1">雪崩效应 <a class="header-anchor" href="#雪崩效应" aria-label="Permalink to &quot;雪崩效应&quot;">​</a></h3><p>概述：在微服务系统架构中，服务间调用关系错综复杂，一个微服务往往依赖于多个其它微服务。一个服务的不可用导致整个系统的不可用的现象就被称之为雪崩效应。</p><p>如下图所示：</p><p><img src="'+n+'" alt="image-20230624203044831"></p><p>当服务D出现了问题了以后，调用服务D的服务A的线程就得不到及时的释放，在高并发情况下，随着时间的不断推移服务A的系统资源会被线程耗尽，最终导致服务A出现了问题，同理就会导致其他的服务也不能进行访问了。</p><h3 id="解决方案" tabindex="-1">解决方案 <a class="header-anchor" href="#解决方案" aria-label="Permalink to &quot;解决方案&quot;">​</a></h3><h4 id="超时处理" tabindex="-1">超时处理 <a class="header-anchor" href="#超时处理" aria-label="Permalink to &quot;超时处理&quot;">​</a></h4><p>超时处理：设定超时时间，请求超过一定时间没有响应就返回错误信息，不会无休止等待</p><p><img src="'+l+'" alt="image-20230624203153340"></p><h4 id="隔离处理" tabindex="-1">隔离处理 <a class="header-anchor" href="#隔离处理" aria-label="Permalink to &quot;隔离处理&quot;">​</a></h4><p>隔离处理：将错误隔离在可控的范围之内，不要让其影响到其他的程序的运行。</p><p>这种设计思想，来源于船舱的设计，如下图所示：</p><p><img src="'+h+'" alt="image-20230624203222353"></p><p>船舱都会被隔板分离为多个独立空间，当船体破损时，只会导致部分空间进入，将故障控制在一定范围内，避免整个船体都被淹没。于此类似，我们业务系统也可以使用这种思想来防止出现雪崩效应，常见的隔离方式：线程隔离</p><p><img src="'+r+'" alt="image-20230624203256590"></p><h4 id="熔断处理" tabindex="-1">熔断处理 <a class="header-anchor" href="#熔断处理" aria-label="Permalink to &quot;熔断处理&quot;">​</a></h4><p>熔断处理：由<strong>断路器</strong>统计业务执行的异常比例，如果超出阈值则会<strong>熔断</strong>该业务，拦截访问该业务的一切请求。</p><p>断路器会统计访问某个服务的请求数量，异常比例如下所示：</p><p><img src="'+k+'" alt="image-20230624203334370"></p><p>请求了三次，两次出现异常，一次成功。当发现访问服务D的请求异常比例过高时，认为服务D有导致雪崩的风险，会拦截访问服务D的一切请求，形成熔断：</p><p><img src="'+o+'" alt="image-20230624203409785"></p><p>触发熔断了以后，当在访问服务A的时候，就不会在通过服务A去访问服务D了，立马给用户进行返回，返回的是一种默认值，这种返回就是一种兜底方案。这种兜底方案也将其称之为降级逻辑。</p><h4 id="流量控制" tabindex="-1">流量控制 <a class="header-anchor" href="#流量控制" aria-label="Permalink to &quot;流量控制&quot;">​</a></h4><p>流量控制：限制业务访问的QPS(每秒的请求数)，避免服务因流量的突增而故障。</p><p><img src="'+d+'" alt="image-20230624203508014"></p><p>限流是一种<strong>预防</strong>措施，避免因瞬间高并发流量而导致服务故障，进而避免雪崩。其他的处理方式是一种<strong>补救</strong>措施，在部分服务故障时，将故障控制在一定范围，避免雪崩。</p><h3 id="sentinel介绍" tabindex="-1">sentinel介绍 <a class="header-anchor" href="#sentinel介绍" aria-label="Permalink to &quot;sentinel介绍&quot;">​</a></h3><p>官网地址：<a href="https://sentinelguard.io/zh-cn/" target="_blank" rel="noreferrer">https://sentinelguard.io/zh-cn/</a></p><p>随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Sentinel 以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。</p><ul><li>Sentinel 的历史：</li></ul><p>- 2012 年，Sentinel 诞生，主要功能为入口流量控制。</p><p>- 2013-2017 年，Sentinel 在阿里巴巴集团内部迅速发展，成为基础技术模块，覆盖了所有的核心场景。Sentinel 也因此积累了大量的流量归整场景以及生产实践。</p><p>- 2018 年，Sentinel 开源，并持续演进。</p><p>- 2019 年，Sentinel 朝着多语言扩展的方向不断探索，推出 C++ 原生版本，同时针对 Service Mesh 场景也推出了 Envoy 集群流量控制支持，以解决 Service Mesh 架构下多语言限流的问题。</p><p>- 2020 年，推出 Sentinel Go 版本，继续朝着云原生方向演进。</p><ul><li>Sentinel 分为两个部分:</li></ul><p>- 核心库（Java 客户端）不依赖任何框架/库，能够运行于所有 Java 运行时环境，同时对 Dubbo / Spring Cloud 等框架也有较好的支持。</p><p>- 控制台（Dashboard）基于 Spring Boot 开发，打包后可以直接运行，不需要额外的 Tomcat 等应用容器。</p><p><img src="'+g+'" alt="image-20230624203655208"></p><p>具有的特征:</p><p><img src="'+E+'" alt="image-20230624203730680"></p><h2 id="sentinel入门" tabindex="-1">sentinel入门 <a class="header-anchor" href="#sentinel入门" aria-label="Permalink to &quot;sentinel入门&quot;">​</a></h2><h3 id="下载sentinel控制台" tabindex="-1">下载sentinel控制台 <a class="header-anchor" href="#下载sentinel控制台" aria-label="Permalink to &quot;下载sentinel控制台&quot;">​</a></h3><p>sentinel管理后台下载地址：<a href="https://github.com/alibaba/Sentinel/releases" target="_blank" rel="noreferrer">https://github.com/alibaba/Sentinel/releases</a></p><p><img src="'+c+'" alt="image-20230624215112184"></p><p>下载完毕以后就会得到一个jar包</p><p><img src="'+m+'" alt="image-20230624215403344"></p><h3 id="启动sentinel" tabindex="-1">启动sentinel <a class="header-anchor" href="#启动sentinel" aria-label="Permalink to &quot;启动sentinel&quot;">​</a></h3><ul><li>将jar包放到任意非中文目录，执行命令：</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">java</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -jar</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sentinel-dashboard-2.0.0-alpha-preview.jar</span></span></code></pre></div><ul><li>如果要修改Sentinel的默认端口、账户、密码，可以通过下列配置：</li></ul><table tabindex="0"><thead><tr><th><strong>配置项</strong></th><th><strong>默认值</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>server.port</td><td>8080</td><td>服务端口</td></tr><tr><td>sentinel.dashboard.auth.username</td><td>sentinel</td><td>默认用户名</td></tr><tr><td>sentinel.dashboard.auth.password</td><td>sentinel</td><td>默认密码</td></tr></tbody></table><ul><li>例如，修改端口：</li></ul><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">java</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -Dserver.port=8090</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -jar</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sentinel-dashboard-2.0.0-alpha-preview.jar</span></span></code></pre></div><h3 id="访问sentinel" tabindex="-1">访问sentinel <a class="header-anchor" href="#访问sentinel" aria-label="Permalink to &quot;访问sentinel&quot;">​</a></h3><p>访问<code>http://localhost:8080</code>页面，就可以看到sentinel的控制台了：</p><p><img src="'+u+'" alt="image-20230624215635555"></p><p>需要输入账号和密码，默认都是：sentinel</p><p>登录后，发现一片空白，什么都没有：因为还没有监控任何服务。另外，sentinel是懒加载的，如果服务没有访问，看不到该服务信息。</p><p><img src="'+y+`" alt="image-20230624215704921"></p><h3 id="整合sentinel" tabindex="-1">整合sentinel <a class="header-anchor" href="#整合sentinel" aria-label="Permalink to &quot;整合sentinel&quot;">​</a></h3><p>我们在spzx-cloud-user中整合sentinel，并连接sentinel的控制台，步骤如下：</p><p>1、引入sentinel依赖</p><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">&lt;!--sentinel--&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;com.alibaba.cloud&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;spring-cloud-starter-alibaba-sentinel&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre></div><p>2、配置控制台</p><p>修改application.yaml文件，添加下面内容</p><div class="language-yml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  cloud</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    sentinel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      transport</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        dashboard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">localhost:8080</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 配置sentinel控制台地址</span></span></code></pre></div><p>3、访问spzx-cloud-user的任意接口</p><p>打开浏览器，访问<code>http://localhost:10100/api/user/findUserByUserId/1</code>，这样才能触发sentinel的监控。然后再访问sentinel的控制台，查看效果：</p><p><img src="`+b+'" alt="image-20230624220303385"></p><h2 id="流量控制-1" tabindex="-1">流量控制 <a class="header-anchor" href="#流量控制-1" aria-label="Permalink to &quot;流量控制&quot;">​</a></h2><p>雪崩问题虽然有四种方案，但是限流是避免服务因突发的流量而发生故障，是对微服务雪崩问题的预防。我们先学习这种模式。</p><h3 id="相关概念" tabindex="-1">相关概念 <a class="header-anchor" href="#相关概念" aria-label="Permalink to &quot;相关概念&quot;">​</a></h3><p><strong>簇点链路</strong>：当请求进入微服务时，首先会访问DispatcherServlet，然后进入Controller、Service、Mapper，这样的一个调用链就叫做簇点链路。</p><p><strong>资源</strong>：簇点链路中被监控的每一个接口就是一个资源，流控、熔断等都是针对簇点链路中的资源来设置的。</p><p>默认情况下sentinel会监控spring mvc的每一个端点（Endpoint，也就是controller中的方法），因此spring mvc的每一个端点就是调用链路中的一个资源。</p>',78),p("p",{userId:""},"例如，我们刚才访问的spzx-cloud-user中的UserController中的端点：/api/user/findUserByUserId/",-1),i('<p><img src="'+F+'" alt="image-20230624220603571"></p><p>我们可以点击对应资源后面的按钮来设置规则：</p><p>1、流控：流量控制</p><p>2、降级：降级熔断</p><p>3、热点：热点参数限流，是限流的一种</p><p>4、授权：请求的权限控制</p><h3 id="快速入门" tabindex="-1">快速入门 <a class="header-anchor" href="#快速入门" aria-label="Permalink to &quot;快速入门&quot;">​</a></h3><p>需求：给 /api/user/findUserByUserId/{userId}这个资源设置流控规则，QPS不能超过 5，然后测试。</p><p>步骤：</p><p>1、首先在sentinel控制台添加限流规则</p><p><img src="'+v+'" alt="image-20230628090407483"></p><p>2、利用jmeter测试(模拟并发请求)</p><blockquote><p>Apache JMeter 是 Apache 组织基于 Java 开发的压力测试工具，用于对软件做<strong>压力测试</strong>。</p><p>下载地址：<a href="https://archive.apache.org/dist/jmeter/binaries/" target="_blank" rel="noreferrer">https://archive.apache.org/dist/jmeter/binaries/</a></p></blockquote><p>课前资料提供了编写好的Jmeter测试样例</p><p><img src="'+C+'" alt="image-20230628115300889"></p><p>通过如下命令打开jmeter</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">java</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -jar</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ApacheJMeter.jar</span></span></code></pre></div><p>导入课前资料提供的测试样例</p><p><img src="'+q+'" alt="image-20220320111824238"></p><p>选择流控入门</p><p><img src="'+B+'" alt="image-20220320111955904"></p><p>10个线程，1秒内运行完，QPS是10，超过了5。</p><p>选中<strong>流控入门，QPS&lt;5</strong>右键运行</p><p><img src="'+I+'" alt="image-20220320112040803"></p><p>注意：不要点击菜单中的执行按钮来运行。</p><p>点击查看结果树，理想的请求执行结果应该如下所示：</p><p><img src="'+A+'" alt="image-20220320112142379"></p><p>可以看到，成功的请求每次只有5个。</p><p><strong>注意：如果测试结果不是上述情况，那是因为sentinel在统计请求的时候，把一部分的请求统计到了下一秒中导致的。</strong></p><h3 id="流控模式" tabindex="-1">流控模式 <a class="header-anchor" href="#流控模式" aria-label="Permalink to &quot;流控模式&quot;">​</a></h3><h4 id="流控模式简介" tabindex="-1">流控模式简介 <a class="header-anchor" href="#流控模式简介" aria-label="Permalink to &quot;流控模式简介&quot;">​</a></h4><p>在添加限流规则时，点击高级选项，可以选择三种<strong>流控模式</strong>：</p><p>1、直接：统计当前资源的请求，触发阈值时对当前资源直接限流，也是默认的模式</p><p>2、关联：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流</p><p>3、链路：统计从指定链路访问到本资源的请求，触发阈值时，对指定链路限流</p><p>如下所示：</p><p><img src="'+S+'" alt="image-20230628091856122"></p><p>快速入门测试的就是直接模式。</p><h4 id="关联模式" tabindex="-1">关联模式 <a class="header-anchor" href="#关联模式" aria-label="Permalink to &quot;关联模式&quot;">​</a></h4><p>关联模式：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流</p><p>配置方式：</p><p><img src="'+R+`" alt="image-20230628092034118"></p><p>语法说明：对/api/user/updateUserById资源的请求进行统计，当访问流量超过阈值时，就对/api/user/findUserByUserId/{userId}进行限流，避免影响/api/user/updateUserById资源。</p><p>使用场景：比如用户支付时需要修改订单状态，同时用户要查询订单。查询和修改操作会争抢数据库锁，产生竞争。业务需求是优先支付和更新订单的业务，因此当修改订单业务触发阈值时，需要对查询订单业务限流。</p><p>案例实现：</p><p>1、在UserController新建一个端点：/api/user/updateUserById，无需实现业务</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 修改用户数据端点</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GetMapping</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;/updateUserById&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">updateUserById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;修改用户数据成功&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>2、重启服务，访问对应的端点，让其产生簇点链路</p><p><img src="`+D+'" alt="image-20230628092515666"></p><p>3、配置流控规则，当/api/user/updateUserById资源被访问的QPS超过5时，对/api/user/findUserByUserId/1请求限流。对哪个端点限流，就点击哪个端点后面的按钮。我们是对用户查询/api/user/findUserByUserId/1限流，因此点击它后面的按钮：</p><p><img src="'+_+'" alt="image-20230628092751648"></p><p>4、在Jmeter中进行测试</p><p>选择《流控模式-关联》：</p><p><img src="'+f+'" alt="image-20220320114459422"></p><p>可以看到1000个线程，100秒，因此QPS为10，超过了我们设定的阈值：5</p><p>查看http请求：</p><p><img src="'+P+'" alt="image-20230628093126793"></p><p>请求的目标是/api/user/updateUserById，这样这个端点就会触发阈值。但限流的目标是/api/user/findUserByUserId/1，我们在浏览器访问，可以发现：</p><p><img src="'+U+'" alt="image-20230628093300378"></p><p>确实被限流了。</p><p>关联流控模式的使用场景：</p><p>1、两个有竞争关系的资源</p><p>2、一个优先级较高，一个优先级较低</p><p>对高优先级的资源的流量进行统计，当超过阈值对低优先级的资源进行限流。</p><h4 id="链路模式" tabindex="-1">链路模式 <a class="header-anchor" href="#链路模式" aria-label="Permalink to &quot;链路模式&quot;">​</a></h4><p>链路模式：只针对从指定链路访问到本资源的请求做统计，判断是否超过阈值，如果超过阈值对从该链路请求进行限流。</p><p>配置方式：</p><p>1、/api/user/save --&gt; users</p><p>2、/api/user/query --&gt; users</p><p>如果只希望统计从/api/user/query进入到users的请求，并进行限流操作，则可以这样配置：</p><p><img src="'+x+`" alt="image-20230628095013326"></p><p>案例实现：</p><p>1、在UserService中添加一个queryUsers方法，不用实现业务</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> queryUsers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(){</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    System.err.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;查询用户&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>2、在UserController中，添加两个端点，在这两个端点中分别调用UserService中的queryUsers方法</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GetMapping</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;/save&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    userService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">queryUsers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;保存用户&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;订单保存成功&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GetMapping</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;/query&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    userService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">queryUsers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;查询用户&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;查询用户成功&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>4、通过**@SentinelResource**标记UserService中的queryUsers方法为一个sentinel监控的资源(默认情况下，sentinel只监控controller方法)</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SentinelResource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;users&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> queryUsers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(){</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    System.err.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;查询用户&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>5、更改application.yml文件中的sentinel配置</p><p>链路模式中，是对不同来源的两个链路做监控。但是sentinel默认会给进入spring mvc的所有请求设置同一个root资源，会导致链路模式失效。因此需要关闭这种资源整合。</p><div class="language-yml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  cloud</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    sentinel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      web-context-unify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 关闭context整合</span></span></code></pre></div><p>6、重启服务，访问/api/user/save和/api/user/query，可以查看到sentinel的簇点链路规则中，出现了新的资源</p><p><img src="`+j+'" alt="image-20230628094306219"></p><p>7、添加流控规则</p><p>点击users资源后面的流控按钮，在弹出的表单中填写下面信息：</p><p><img src="'+J+'" alt="image-20230628094433574"></p><p>只统计从/api/user/query进入/users的资源，QPS阈值为2，超出则被限流。</p><p>8、jmeter测试</p><p>选择《流控模式-链路》</p><p><img src="'+N+'" alt="image-20220320150559229"></p><p>可以看到这里200个线程，50秒内发完，QPS为4，超过了我们设定的阈值2。</p><p>一个http请求是访问/api/user/save</p><p><img src="'+V+'" alt="image-20230628094648097"></p><p>另一个是访问/api/user/query</p><p><img src="'+w+'" alt="image-20230628094713655"></p><p>运行测试，察看结果树：</p><p>访问/api/user/save,没有进行限流</p><p><img src="'+M+'" alt="image-20230628094814795"></p><p>访问/api/user/query,进行限流了</p><p><img src="'+T+'" alt="image-20230628094857374"></p><h3 id="流控效果" tabindex="-1">流控效果 <a class="header-anchor" href="#流控效果" aria-label="Permalink to &quot;流控效果&quot;">​</a></h3><p>在流控的高级选项中，还有一个流控效果选项</p><p><img src="'+G+'" alt="image-20230628095109686"></p><p>流控效果是指请求达到流控阈值时应该采取的措施，包括三种：</p><p>1、快速失败：达到阈值后，新的请求会被立即拒绝并抛出FlowException异常，是默认的处理方式</p><p>2、warm up：预热模式，对超出阈值的请求同样是拒绝并抛出异常，但这种模式阈值会动态变化，从一个较小值逐渐增加到最大阈值</p><p>3、排队等待：让所有的请求按照先后次序进入到一个队列中进行排队，当某一个请求最大的预期等待时间超过了所设定的超时时间时同样是拒绝并抛出异常</p><h4 id="warm-up" tabindex="-1">warm up <a class="header-anchor" href="#warm-up" aria-label="Permalink to &quot;warm up&quot;">​</a></h4><p>阈值一般是一个微服务能承担的最大QPS，但是一个服务刚刚启动时，一切资源尚未初始化（<strong>冷启动</strong>），如果直接将QPS跑到最大值，可能导致服务瞬间宕机。</p><p>warm up也叫<strong>预热模式</strong>，是应对服务冷启动的一种方案。<strong>阈值会动态变化</strong>，从一个较小值逐渐增加到最大阈值。</p><p><strong>工作特点</strong>：请求阈值初始值是 maxThreshold / coldFactor, 持续指定时长(预热时间)后，逐渐提高到maxThreshold值，而coldFactor的默认值是3。</p><p>例如，我设置QPS的maxThreshold为10，预热时间为5秒，那么初始阈值就是 10 / 3 ，也就是3，然后在5秒后逐渐增长到10。</p><p><img src="'+Q+'" alt="image-20220320152944101"></p><p><strong>案例需求</strong>：给/api/user/findUserByUserId/{userId}这个资源设置限流，最大QPS为10，利用warm up效果，预热时长为5秒</p><p>1、配置流控规则</p><p><img src="'+L+'" alt="image-20230628095505037"></p><p>2、jmeter测试</p><p>选择《流控效果，warm up》</p><p><img src="'+W+'" alt="image-20220320153409220"></p><p>QPS为10</p><p>刚刚启动时，大部分请求失败，成功的只有3个，说明QPS被限定在3：</p><p><img src="'+z+'" alt="image-20220320153522505"></p><p>随着时间推移，成功比例越来越高</p><p><img src="'+H+'" alt="image-20220320153646510"></p><p>到sentinel控制台查看实时监控</p><p><img src="'+Y+'" alt="image-20230628095925921"></p><h4 id="排队等待" tabindex="-1">排队等待 <a class="header-anchor" href="#排队等待" aria-label="Permalink to &quot;排队等待&quot;">​</a></h4><p><strong>排队等待</strong>：让所有的请求按照先后次序进入到一个队列中进行排队，当某一个请求最大的预期等待时间超过了所设定的超时时间时同样是拒绝并抛出异常</p><p>例如：QPS = 5，意味着每200ms处理一个队列中的请求；timeout = 2000，意味着<strong>预期等待时长</strong>超过2000ms的请求会被拒绝并抛出异常。</p><p>那什么叫做预期等待时长呢？</p><p>比如现在一下子来了12 个请求，因为每200ms执行一个请求，那么：</p><p>1、第6个请求的<strong>预期等待时长</strong> = 200 * （6 - 1） = 1000ms</p><p>2、第12个请求的预期等待时长 = 200 * （12-1） = 2200ms</p><p>现在，第1秒同时接收到10个请求，但第2秒只有1个请求，此时QPS的曲线这样的：</p><p><img src="'+O+'" alt="image-20230628100019712"></p><p>如果使用队列模式做流控，所有进入的请求都要排队，以固定的200ms的间隔执行，QPS会变的很平滑</p><p><img src="'+Z+'" alt="image-20230628100049968"></p><p>平滑的QPS曲线，对于服务器来说是更友好的。</p><p><strong>案例需求</strong>：给/api/user/findUserByUserId/{userId}这个资源设置限流，最大QPS为10，利用排队的流控效果，超时时长设置为5s</p><p>1、添加流控规则</p><p><img src="'+K+'" alt="image-20230628100313331"></p><p>2、jmeter测试</p><p><img src="'+X+'" alt="image-20220320154801992"></p><p>QPS为15，已经超过了我们设定的10。</p><p>运行测试用例，察看结果树：</p><p><img src="'+$+'" alt="image-20220320155103019"></p><p>全部都通过了。</p><p>再去sentinel查看实时监控的QPS曲线</p><p><img src="'+ss+'" alt="image-20220320155202523"></p><p>QPS非常平滑，一致保持在10，但是超出的请求没有被拒绝，而是放入队列。因此<strong>响应时间</strong>（等待时间）会越来越长。</p><h3 id="热点参数限流" tabindex="-1">热点参数限流 <a class="header-anchor" href="#热点参数限流" aria-label="Permalink to &quot;热点参数限流&quot;">​</a></h3><h4 id="配置介绍" tabindex="-1">配置介绍 <a class="header-anchor" href="#配置介绍" aria-label="Permalink to &quot;配置介绍&quot;">​</a></h4><p>之前的限流是统计访问某个资源的所有请求，判断是否超过QPS阈值。而热点参数限流是<strong>分别统计参数值相同的请求</strong>，判断是否超过QPS阈值。</p><p>例如，一个根据id查询商品的接口：</p><p><img src="'+is+'" alt="image-20230628100914491"></p><p>访问/goods/{id}的请求中，id参数值会有变化，热点参数限流会根据参数值分别统计QPS，统计结果：</p><p><img src="'+as+'" alt="image-20230628101012945"></p><p>当id=1的请求触发阈值被限流时，id值不为1的请求不受影响。</p><p>配置方式(点击资源中的热点按钮)：</p><p><img src="'+ts+'" alt="image-20230628101216576"></p><p>代表的含义是：对hot这个资源的0号参数（第一个参数）做统计，每1秒<strong>相同参数值</strong>的请求数不能超过2。这种配置是对查询商品这个接口的所有商品一视同仁，QPS都限定为5。而在实际开发中，可能部分商品是热点商品，例如秒杀商品，我们希望这部分商品的QPS限制与其它商品不一样，高一些。那就需要配置热点参数限流的高级选项了：</p><p><img src="'+es+`" alt="image-20230628101331468"></p><h4 id="案例演示" tabindex="-1">案例演示 <a class="header-anchor" href="#案例演示" aria-label="Permalink to &quot;案例演示&quot;">​</a></h4><p><strong>案例需求</strong>：给/api/user/findUserByUserId/{userId}这个资源添加热点参数限流，规则如下：</p><p>1、默认的热点参数规则是每1秒请求量不超过2</p><p>2、给2这个参数设置例外：每1秒请求量不超过4</p><p>3、给3这个参数设置例外：每1秒请求量不超过10</p><p><strong>注意事项</strong>：热点参数限流对默认的spring mvc资源无效，需要利用@SentinelResource注解标记资源</p><p>实现步骤：</p><p>1、标记资源</p><p>给UserController中的/api/user/findUserByUserId/{userId}资源添加注解：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SentinelResource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;hot&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 声明资源名称</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GetMapping</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;/findUserByUserId/{userId}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> User </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">findUserByUserId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PathVariable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;userId&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) Long userId ,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                             @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RequestHeader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Truth&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> , </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">required</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)String header) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;UserController...findUserByUserId方法执行了... ,header: {} , dateformat: {} &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> , header , patternProperties.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getDateformat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> userService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">findUserByUserId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(userId) ;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>2、热点参数限流规则</p><p>访问该接口，可以看到我们标记的hot资源出现了</p><p><img src="`+ps+'" alt="image-20230628101715773"></p><p>这里不要点击hot后面的按钮，页面有BUG</p><p>点击左侧菜单中<strong>热点规则</strong>菜单：</p><p><img src="'+ns+'" alt="image-20230628102031276"></p><p>3、jmeter测试</p><p>选择《热点参数限流 QPS1》</p><p><img src="'+ls+'" alt="image-20220320162420189"></p><p>这里发起请求的QPS为5。</p><p>包含三个请求，参数分别为：101 ， 102 ， 103，运行测试程序，察看结果树：</p><table tabindex="0"><thead><tr><th>101</th><th><img src="'+hs+'" alt="image-20220320162905731"></th></tr></thead><tbody><tr><td>102</td><td><img src="'+rs+'" alt="image-20220320163002195"></td></tr><tr><td>103</td><td><img src="'+ks+'" alt="image-20220320163023729"></td></tr></tbody></table>',184)]))}const Fs=a(os,[["render",ds]]);export{bs as __pageData,Fs as default};
