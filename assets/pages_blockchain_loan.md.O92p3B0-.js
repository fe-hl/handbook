import{_ as i,c as a,o as n,ao as l}from"./chunks/framework.DOhyS95j.js";const h="/handbook/assets/loan.BnsDgiWg.png",y=JSON.parse('{"title":"🔗 去中心化借贷协议：流程、收益与技术实现","description":"","frontmatter":{},"headers":[],"relativePath":"pages/blockchain/loan.md","filePath":"pages/blockchain/loan.md"}'),t={name:"pages/blockchain/loan.md"};function k(p,s,e,r,E,d){return n(),a("div",null,s[0]||(s[0]=[l('<h1 id="🔗-去中心化借贷协议-流程、收益与技术实现" tabindex="-1">🔗 去中心化借贷协议：流程、收益与技术实现 <a class="header-anchor" href="#🔗-去中心化借贷协议-流程、收益与技术实现" aria-label="Permalink to &quot;🔗 去中心化借贷协议：流程、收益与技术实现&quot;">​</a></h1><h2 id="_1-⛓️-去中心化借贷协议概述" tabindex="-1">1 ⛓️ 去中心化借贷协议概述 <a class="header-anchor" href="#_1-⛓️-去中心化借贷协议概述" aria-label="Permalink to &quot;1 ⛓️ 去中心化借贷协议概述&quot;">​</a></h2><p>与传统金融不同，DeFi 借贷是<strong>点对合约</strong>的，无需中介。用户直接与智能合约交互，<strong>存入资产以赚取利息，或提供超额抵押品以借出资产</strong>。其核心优势在于：</p><ul><li><strong>无许可性</strong>：任何人、任何地方均可参与。</li><li><strong>透明性</strong>：所有交易和利率在链上公开可查。</li><li><strong>可组合性</strong>：可作为其他 DeFi 应用（如杠杆交易、收益农场）的基础乐高积木。</li></ul><h2 id="_2-🔄-核心业务流程" tabindex="-1">2 🔄 核心业务流程 <a class="header-anchor" href="#_2-🔄-核心业务流程" aria-label="Permalink to &quot;2 🔄 核心业务流程&quot;">​</a></h2><p>一个完整的借贷流程涉及多方参与和复杂的链上交互，其核心业务逻辑与资金流转如下图所示：</p><p><img src="'+h+`" alt="借贷"></p><h3 id="_2-1-存款流程" tabindex="-1">2.1 存款流程 <a class="header-anchor" href="#_2-1-存款流程" aria-label="Permalink to &quot;2.1 存款流程&quot;">​</a></h3><ol><li><strong>用户授权</strong>：用户首先授权借贷合约（如 <code>LendingPool</code>）操作其代币（如 USDC）。这是一笔独立的交易。</li><li><strong>执行存款</strong>：用户调用合约的 <code>deposit()</code> 方法。合约将代币从用户钱包转移至合约本身（资金池），并<strong>铸造计息凭证代币（Interest Bearing Token）</strong> 给用户，如<code>cUSDC</code>或<code>aUSDC</code>。</li><li><strong>凭证代币</strong>：这些凭证代币是<strong>用户的本金和应计利息的所有权证明</strong>。它们本身是 ERC-20 代币，可以转移、交易，甚至用于其他 DeFi 协议（可组合性）。</li><li><strong>开始计息</strong>：从此刻起，用户的存款开始根据资金池的<strong>当前利率</strong>累积利息。其凭证代币的余额会随时间增加（或单位凭证代表的底层资产增加）。</li></ol><h3 id="_2-2-借款流程" tabindex="-1">2.2 借款流程 <a class="header-anchor" href="#_2-2-借款流程" aria-label="Permalink to &quot;2.2 借款流程&quot;">​</a></h3><ol><li><strong>超额抵押</strong>：借款人必须首先存入某种<strong>抵押资产</strong>（如 ETH）。借款额度由抵押物的价值和该资产的<strong>贷款价值比（LTV）</strong> 决定。例如，存入价值$100 的 ETH（LTV=75%），最多可借出$75 的其他资产。</li><li><strong>执行借款</strong>：借款人调用 <code>borrow()</code> 方法，指定借款资产和数量。合约会检查借款人的健康因子是否安全。</li><li><strong>健康因子（Health Factor）</strong>：这是一个数值，代表抵押资产的价值与借款资产价值的比率。<strong>如果该值低于 1，借款人的头寸将被清算</strong>。 <code>健康因子 = (抵押物价值 * 清算阈值) / 借款价值</code></li><li><strong>支付利息</strong>：借款利息通常是<strong>浮动的</strong>，根据资产的需求实时变化。利息从借款人的未偿还债务中累积。</li></ol><h3 id="_2-3-清算流程" tabindex="-1">2.3 清算流程 <a class="header-anchor" href="#_2-3-清算流程" aria-label="Permalink to &quot;2.3 清算流程&quot;">​</a></h3><p>当抵押物价值下跌或借款价值上涨导致<strong>健康因子低于 1</strong>时，任何清算人都可以调用 <code>liquidate()</code> 函数。</p><ul><li>清算人以折扣价购买抵押资产（如以$95 的价格购买价值$100 的抵押 ETH），差价作为利润。</li><li>借款人的部分或全部债务被偿还，协议通常会对被清算的借款人收取一笔额外的<strong>清算罚金</strong>，一部分给协议，一部分给清算人。</li></ul><h2 id="_3-💰-收益与佣金分配机制" tabindex="-1">3 💰 收益与佣金分配机制 <a class="header-anchor" href="#_3-💰-收益与佣金分配机制" aria-label="Permalink to &quot;3 💰 收益与佣金分配机制&quot;">​</a></h2><h3 id="_3-1-用户的收益-存款人" tabindex="-1">3.1 用户的收益（存款人） <a class="header-anchor" href="#_3-1-用户的收益-存款人" aria-label="Permalink to &quot;3.1 用户的收益（存款人）&quot;">​</a></h3><p>存款人的收益来源相对直接，主要来自于借款人支付的利息。</p><ul><li><strong>存款利息</strong>：收益来自于借款人支付的利息。利率由<strong>资金利用率（U）</strong> 动态决定：<code>U = 总借款 / 总存款</code>。 <ul><li>利用率越低，存款利率越低（资金供给过剩）。</li><li>利用率越高，存款利率越高（资金需求旺盛）。</li></ul></li><li><strong>计算方式</strong>：你的收益体现在你持有的<strong>计息凭证代币</strong>的增值上。你可以通过比较 <code>balanceOfUnderlying(yourAddress)</code> 在你存入时和现在的差值来计算具体收益。</li></ul><h3 id="_3-2-平台的收益" tabindex="-1">3.2 平台的收益 <a class="header-anchor" href="#_3-2-平台的收益" aria-label="Permalink to &quot;3.2 平台的收益&quot;">​</a></h3><p>协议的收益（佣金）并非直接收取，而是通过精巧的利率模型从存贷利差中产生。</p><ul><li><strong>利差（Spread）</strong>：这是平台最核心的收入来源。协议设定的<strong>借款利率 &gt; 存款利率</strong>，其中的差价即为协议收入。例如，借款利率为 5%，存款利率为 4%，则利差为 1%。</li><li><strong>清算罚金分成</strong>：当发生清算时，借款人需要支付一笔额外的罚金（例如，抵押物价值的 10%）。这笔罚金通常大部分给清算人（如 7.5%）作为激励，剩余部分则归协议国库（如 2.5%）。</li><li><strong>其他费用</strong>：部分协议可能会对提现或特定交易收取少量固定费用。</li></ul><h3 id="_3-3-佣金分配案例" tabindex="-1">3.3 佣金分配案例 <a class="header-anchor" href="#_3-3-佣金分配案例" aria-label="Permalink to &quot;3.3 佣金分配案例&quot;">​</a></h3><p>假设协议在某段时间内：</p><ul><li><strong>总存款</strong>：1000 USDC</li><li><strong>总借款</strong>：600 USDC</li><li><strong>资金利用率 (U)</strong>：60%</li><li><strong>存款利率</strong>：3% (根据 U 计算得出)</li><li><strong>借款利率</strong>：4% (根据 U 计算得出)</li><li><strong>利差</strong>：1%</li></ul><p><strong>平台收益计算</strong>： 平台佣金 = 总借款 _ 利差 = 600 USDC _ 1% = <strong>6 USDC</strong></p><p>这 6 USDC 会累积到协议的国库地址（Treasury）。协议治理可以决定如何使用这些资金（如分配给代币质押者、用于开发、回购销毁代币等）。</p><h2 id="_4-⚙️-技术实现-前后端与智能合约" tabindex="-1">4 ⚙️ 技术实现：前后端与智能合约 <a class="header-anchor" href="#_4-⚙️-技术实现-前后端与智能合约" aria-label="Permalink to &quot;4 ⚙️ 技术实现：前后端与智能合约&quot;">​</a></h2><h3 id="_4-1-智能合约开发" tabindex="-1">4.1 智能合约开发 <a class="header-anchor" href="#_4-1-智能合约开发" aria-label="Permalink to &quot;4.1 智能合约开发&quot;">​</a></h3><p>智能合约是协议的核心，其设计至关重要。通常采用经过审计的、模块化的架构。</p><h4 id="_4-1-1-核心合约结构" tabindex="-1">4.1.1 核心合约结构 <a class="header-anchor" href="#_4-1-1-核心合约结构" aria-label="Permalink to &quot;4.1.1 核心合约结构&quot;">​</a></h4><div class="language-solidity vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">solidity</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// SPDX-License-Identifier: MIT</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">pragma</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;"> solidity</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ^0.8.19</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;@openzeppelin/contracts/token/ERC20/IERC20.sol&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;@openzeppelin/contracts/access/Ownable.sol&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 计息凭证代币合约</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">contract</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cToken</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> is</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ERC20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Ownable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ReentrancyGuard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    using</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SafeERC20</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> for</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IERC20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    IERC20 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> immutable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> underlyingAsset;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    uint256</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> exchangeRate; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 1 cToken = X underlying tokens</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> mint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">address</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> to</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">uint256</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> amount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">external</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> onlyOwner</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        _mint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(to, amount);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 更新汇率逻辑...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> burn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">address</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">uint256</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> amount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">external</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> onlyOwner</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        _burn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(from, amount);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 更新汇率逻辑...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 核心资金池合约</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">contract</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LendingPool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> is</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ReentrancyGuard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Ownable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    using</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SafeERC20</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> for</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IERC20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Market</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        uint256</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> totalBorrows;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        uint256</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> totalSupplies;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        uint256</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> borrowRate;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        uint256</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> supplyRate;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> isActive;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        cToken cTokenAddress;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    mapping</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">address</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Market) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> markets;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    mapping</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">address</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> mapping</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">address</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> uint256</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> userBorrows; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// user -&gt; asset -&gt; amount</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    mapping</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">address</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> mapping</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">address</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> uint256</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> userCollateral; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// user -&gt; asset -&gt; amount</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    address</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> oracle; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 价格预言机地址</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    event</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Deposited</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">address</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> indexed</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">address</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> indexed</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> asset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">uint256</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> amount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    event</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Borrowed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">address</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> indexed</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">address</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> indexed</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> asset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">uint256</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> amount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    constructor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _oracle) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        oracle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _oracle;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> deposit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _asset, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">uint256</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _amount) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">external</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> nonReentrant</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Market </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">storage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> market </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> markets[_asset];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(market.isActive, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Market not active&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        IERC20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_asset).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">safeTransferFrom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">msg.sender</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), _amount);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 根据当前汇率计算应铸造的cToken数量</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        uint256</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cTokensToMint </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (_amount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1e18</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> market.exchangeRate;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        market.cTokenAddress.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">msg.sender</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, cTokensToMint);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        market.totalSupplies </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _amount;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        updateInterestRates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_asset);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        emit</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Deposited</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">msg.sender</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, _asset, _amount);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> borrow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _asset, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">uint256</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _amount) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">external</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> nonReentrant</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Market </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">storage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> market </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> markets[_asset];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(market.isActive, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Market not active&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 检查健康因子是否安全</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">_calculateHealthFactor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">msg.sender</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1e18</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Health factor too low&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 从资金池中转出资产给借款人</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        IERC20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_asset).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">safeTransfer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">msg.sender</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, _amount);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        userBorrows[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">msg.sender</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">][_asset] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _amount;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        market.totalBorrows </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _amount;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        updateInterestRates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_asset);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        emit</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Borrowed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">msg.sender</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, _asset, _amount);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _calculateHealthFactor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _user) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">internal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> view</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> returns</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">uint256</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 1. 通过预言机获取用户所有抵押物的总价值（USD）</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 2. 通过预言机获取用户所有借款的总价值（USD）</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 3. 应用清算阈值</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 4. 返回: (总抵押价值 * 清算阈值) / 总借款价值</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 简化实现</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2e18</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 返回一个假设的安全值</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> updateInterestRates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _asset) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">internal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Market </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">storage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> market </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> markets[_asset];</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        uint256</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> utilizationRate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (market.totalBorrows </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1e18</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> market.totalSupplies;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 一个非常简化的利率模型示例</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (utilizationRate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8e18</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            market.borrowRate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">05e18</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 5%</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            market.supplyRate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">04e18</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 4% -&gt; 利差1%</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            market.borrowRate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">03e18</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 3%</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            market.supplyRate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">025e18</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 2.5% -&gt; 利差0.5%</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 管理员函数：添加新市场</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> addMarket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _asset, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _cToken) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">external</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> onlyOwner</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        markets[_asset] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Market</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            totalBorrows</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            totalSupplies</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            borrowRate</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            supplyRate</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            isActive</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            cTokenAddress</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cToken</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_cToken)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h4 id="_4-1-2-安全考量" tabindex="-1">4.1.2 安全考量 <a class="header-anchor" href="#_4-1-2-安全考量" aria-label="Permalink to &quot;4.1.2 安全考量&quot;">​</a></h4><ul><li><strong>价格预言机</strong>：<strong>绝对不要使用单一来源或可操纵的价格</strong>。必须使用去中心化的预言机网络，如 Chainlink，并具有防闪电贷攻击的保护（例如，使用最近一次的价格而非实时价格）。</li><li><strong>重入攻击</strong>：使用 <code>ReentrancyGuard</code> 修饰所有外部函数，尤其是在转移代币之前更新状态。</li><li><strong>数学计算</strong>：使用 Solidity 0.8.x 的内置安全数学，或 OpenZeppelin 的 SafeMath 库（对于旧版本）。</li><li><strong>利率模型</strong>：确保利率计算不会导致溢出或被恶意操纵。</li><li><strong>清算激励</strong>：清算系统必须设计得当，确保有足够的激励让清算人及时清算，同时避免过度惩罚借款人。</li></ul><h3 id="_4-2-后端开发" tabindex="-1">4.2 后端开发 <a class="header-anchor" href="#_4-2-后端开发" aria-label="Permalink to &quot;4.2 后端开发&quot;">​</a></h3><p>后端主要负责索引链上数据并提供易于查询的 API。</p><ul><li><strong>技术栈</strong>：Node.js + Express/NestJS, Python + FastAPI, 或 Go。数据库常用 PostgreSQL 或 MongoDB。</li><li><strong>核心任务</strong>： <ul><li><strong>索引事件</strong>：使用<code>ethers.js</code>/<code>web3.py</code>监听并索引合约中的<code>Deposited</code>、<code>Borrowed</code>、<code>Liquidated</code>等事件，将其存入数据库。</li><li><strong>计算聚合数据</strong>：计算并缓存全局数据，如总锁仓量（TVL）、各市场利率、平台总收入等。这些数据在链上计算可能非常昂贵。</li><li><strong>提供 API</strong>： <ul><li><code>GET /markets</code>: 返回所有市场详情（存款量、借款量、利率等）。</li><li><code>GET /users/:address</code>: 返回用户头寸详情（存款、借款、健康因子）。</li></ul></li><li><strong>监控健康因子</strong>：可以运行后台任务监控所有用户的风险指标，并为接近清算的用户提供预警（可选）。</li></ul></li></ul><h3 id="_4-3-前端开发" tabindex="-1">4.3 前端开发 <a class="header-anchor" href="#_4-3-前端开发" aria-label="Permalink to &quot;4.3 前端开发&quot;">​</a></h3><p>前端是用户交互的窗口，需要清晰展示复杂信息并确保交易安全。</p><ul><li><strong>技术栈</strong>：React（主流）或 Vue.js，搭配 Ethers.js 或 Viem（新一代 Web3 库）。</li><li><strong>核心功能</strong>： <ul><li><strong>钱包集成</strong>：无缝连接 MetaMask、WalletConnect 等，获取用户地址和余额。</li><li><strong>数据展示</strong>：从后端 API 和链上合约获取数据，展示市场列表、用户头寸、资产价格、健康因子等。</li><li><strong>合约交互</strong>：构建交易以调用<code>deposit</code>、<code>borrow</code>、<code>repay</code>等方法。清晰显示 Gas 费预估。</li><li><strong>交易状态反馈</strong>：提供交易状态（确认中、成功/失败）和区块链浏览器链接。</li><li><strong>风险管理</strong>：在用户进行高风险操作（如借款导致健康因子过低）时给出强烈警告。</li></ul></li></ul>`,39)]))}const o=i(t,[["render",k]]);export{y as __pageData,o as default};
